var D=(t=>(t.DISABLED="disabled",t.SOFT="soft",t.STRICT="strict",t))(D||{});var R="stc-backend",w=(n=>(n.ALLOW="allow",n.BLOCK="block",n))(w||{});function b(r){let e=null;return()=>(e||(e=r()),e)}var _=b(()=>import("jose/jwt/verify")),L=b(()=>import("jose/jwt/decode")),P=b(()=>import("jose/decode/protected_header")),M=b(()=>import("jose/key/import")),j=b(()=>import("jose/jwt/sign"));var k=new Map;function G(r,e){let n=k.get(r);if(!n)return null;let t=Math.floor(Date.now()/1e3);return n.exp>t+30?(e&&console.debug(`Using cached license token (expires in ${n.exp-t}s)`),n.token):(e&&console.debug("Cached license token expired or expiring soon, refreshing"),k.delete(r),null)}async function X(r,e,n){try{let t=await fetch(r,e);if(!t.ok){let s=await t.text().catch(()=>""),c=`Failed to obtain license token: ${t.status} ${t.statusText}${s?` - ${s}`:""}`;throw new Error(c)}let o;try{o=await t.json()}catch(s){throw n&&console.error("Failed to parse license token response as JSON:",s),new Error("Failed to parse license token response as JSON")}if(!o?.access_token)throw new Error("License token response missing access_token");return o.access_token}catch(t){throw n&&console.error("Error generating license token:",t),t}}async function z(r,e){let t=`${new URL(r).origin}/license.xml`,o=await fetch(t);if(!o.ok)throw e&&console.error(`Failed to fetch license.xml from ${t}: ${o.status}`),new Error(`Failed to fetch license.xml from ${t}: ${o.status}`);let s=await o.text();return e&&console.debug("Fetched license.xml from",t),s}function Y(r,e){let n=[],t=/<content\s([^>]*)>([\s\S]*?)<\/content>/gi,o=/url\s*=\s*"([^"]*)"/i,s=/server\s*=\s*"([^"]*)"/i,c=/<license[^>]*>[\s\S]*?<\/license>/i,a=0,i;for(;(i=t.exec(r))!==null;){a++;let l=i[1],d=i[2],g=l.match(o),f=l.match(s),h=d.match(c);if(g&&f&&h)n.push({urlPattern:g[1],server:f[1],licenseXml:h[0]});else if(e){let y=[!g&&"url",!f&&"server",!h&&"<license>"].filter(Boolean).join(", ");console.debug(`Skipping <content> element #${a}: missing ${y}`)}}return e&&console.debug(`Found ${a} <content> element(s), ${n.length} valid`),n}function Q(r,e,n){let t=new URL(e),o=t.host,s=t.pathname;n&&console.debug(`Matching resource URL: ${e} (host=${o}, path=${s})`);let c=null,a=-1;for(let i of r){let l;try{l=new URL(i.urlPattern)}catch{n&&console.debug(`Skipping block with invalid URL pattern: ${i.urlPattern}`);continue}if(l.host!==o){n&&console.debug(`Skipping block: host mismatch (pattern=${l.host}, resource=${o})`);continue}let d=l.pathname;if(d===s)return n&&console.debug(`Exact match found: ${i.urlPattern}`),i;if(d.endsWith("/*")){let g=d.slice(0,-1);if(s.startsWith(g)){let f=g.length;f>a&&(a=f,c=i)}}}return n&&console.debug(c?`Wildcard match found: ${c.urlPattern} (specificity=${a})`:`No matching content block found for ${e}`),c}async function q({clientId:r,clientSecret:e,resourceUrl:n,debug:t}){let o=`${r}:${n}`,s=G(o,t);if(s)return s;let c=await z(n,t);t&&console.debug(`Fetched license.xml (${c.length} chars)`);let a=Y(c,t);if(a.length===0)throw t&&console.error("No valid <content> elements with <license> found in license.xml"),new Error("No valid <content> elements with <license> found in license.xml");let i=Q(a,n,t);if(!i){if(t){let h=a.map(y=>y.urlPattern).join(", ");console.error(`No <content> element matches resource URL: ${n}. Available patterns: ${h}`)}throw new Error(`No <content> element in license.xml matches resource URL: ${n}`)}t&&(console.debug("Matched content block for resource URL:",n),console.debug("Using license XML:",i.licenseXml));let l=i.server+"/token";t&&console.debug(`Requesting license token from ${l}`);let d=new URLSearchParams({grant_type:"client_credentials",license:i.licenseXml,resource:i.urlPattern}),g={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json",Authorization:"Basic "+btoa(`${r}:${e}`)},body:d.toString()},f=await X(l,g,t);try{let{decodeJwt:h}=await L(),y=h(f);y.exp&&k.set(o,{token:f,exp:y.exp})}catch{t&&console.debug("Failed to decode token for caching, skipping cache")}return f}var I=new Map;function Z(){let r={method:"GET"};return globalThis?.fastly&&(r={...r,backend:R}),r}async function ee({cacheKey:r,url:e,debug:n,failureMessage:t,logLabel:o}){if(!I.has(r))try{let s=await fetch(e,Z());if(!s.ok)throw new Error(`${t}: ${s.status}`);let c=await s.json();I.set(r,c)}catch(s){throw n&&console.error(o,s),s}return I.get(r)}async function F(r,e){let n=`${r}/.well-known/jwks.json/platform`;return e&&console.debug(`Fetching platform JWKS from URL: ${n}`),ee({cacheKey:"platform_jwks",url:n,debug:e,failureMessage:"Failed to fetch platform JWKS",logLabel:"Error fetching platform JWKS:"})}async function N({apiKey:r,baseUrl:e,eventName:n,properties:t,licenseId:o,debug:s=!1}){let c={event_name:n,license_id:o,properties:t};try{let a={method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify(c)};globalThis?.fastly&&(a={...a,backend:R});let i=await fetch(`${e}/events`,a);!i.ok&&s&&console.error(`Failed to record event: ${i.status}`)}catch(a){s&&console.error("Error recording event:",a)}}var x=r=>r.trim().replace(/\/+$/,"");function m(r){switch(r){case"missing_license_token":return"Authorization header missing or malformed";case"invalid_license_algorithm":return"Unsupported token algorithm";case"license_token_expired":return"The license token has expired";case"license_signature_verification_failed":return"The license token signature is invalid";case"invalid_license_header":return"The license token header is malformed";case"invalid_license_payload":return"The license token payload is malformed";case"invalid_license_issuer":return"The license token issuer is not recognized";case"invalid_license_audience":return"The license does not grant access to this resource";case"server_error":return"The server encountered an error validating the license";default:return"License token missing, expired, revoked, or malformed"}}async function A({licenseToken:r,requestUrl:e,supertabBaseUrl:n,debug:t}){let{decodeProtectedHeader:o}=await P(),{decodeJwt:s}=await L(),{jwtVerify:c}=await _();if(!r)return{valid:!1,reason:"missing_license_token",error:m("missing_license_token")};let a;try{a=o(r)}catch(p){return t&&console.error("Invalid license JWT header:",p),{valid:!1,reason:"invalid_license_header",error:m("invalid_license_header")}}if(a.alg!=="ES256")return t&&console.error("Unsupported license JWT alg:",a.alg),{valid:!1,reason:"invalid_license_algorithm",error:m("invalid_license_algorithm")};let i;try{i=s(r)}catch(p){return t&&console.error("Invalid license JWT payload:",p),{valid:!1,reason:"invalid_license_payload",error:m("invalid_license_payload")}}let l=i.license_id,d=i.iss,g=d?x(d):void 0,f=x(n);if(!g||!g.startsWith(f))return t&&console.error("License JWT issuer is missing or malformed:",d),{valid:!1,reason:"invalid_license_issuer",error:m("invalid_license_issuer"),licenseId:l};let h=Array.isArray(i.aud)?i.aud.filter(p=>typeof p=="string"):typeof i.aud=="string"?[i.aud]:[],y=x(e);if(!h.some(p=>{let E=x(p);return E?y.startsWith(E):!1}))return t&&console.error("License JWT audience does not match request URL:",i.aud),{valid:!1,reason:"invalid_license_audience",error:m("invalid_license_audience"),licenseId:l};let T;try{T=await F(n,t)}catch(p){return t&&console.error("Failed to fetch platform JWKS:",p),{valid:!1,reason:"server_error",error:m("server_error"),licenseId:l}}try{let E=await c(r,async C=>{let U=T.keys.find(W=>W.kid===C.kid);if(!U)throw new Error(`No matching platform key found: ${C.kid}`);return U},{issuer:d,algorithms:[a.alg],clockTolerance:"1m"});return{valid:!0,licenseId:l,payload:E.payload}}catch(p){return t&&console.error("License JWT verification failed:",p),p instanceof Error&&p.message?.includes("exp")?{valid:!1,reason:"license_token_expired",error:m("license_token_expired"),licenseId:l}:{valid:!1,reason:"license_signature_verification_failed",error:m("license_signature_verification_failed"),licenseId:l}}}function O({requestUrl:r}){try{let e=new URL(r);return`${e.protocol}//${e.host}/license.xml`}catch(e){return console.error("[SupertabConnect] generateLicenseLink failed to parse URL:",e),"/license.xml"}}function H(r){let e=O({requestUrl:r});return{action:"allow",headers:{Link:`<${e}>; rel="license"; type="application/rsl+xml"`,"X-RSL-Status":"token_required","X-RSL-Reason":"missing"}}}function ne(r){switch(r){case"missing_license_token":case"invalid_license_algorithm":return{rslError:"invalid_request",status:401};case"license_token_expired":case"license_signature_verification_failed":case"invalid_license_header":case"invalid_license_payload":case"invalid_license_issuer":return{rslError:"invalid_token",status:401};case"invalid_license_audience":return{rslError:"insufficient_scope",status:403};case"server_error":return{rslError:"server_error",status:503};default:return{rslError:"invalid_token",status:401}}}function re(r){return r.replace(/[\r\n]/g,"").replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function S({reason:r,error:e,requestUrl:n}){let{rslError:t,status:o}=ne(r),s=re(e),c=O({requestUrl:n});return{action:"block",status:o,body:`Access to this resource requires a valid license token. Error: ${t} - ${e}`,headers:{"Content-Type":"text/plain; charset=UTF-8","WWW-Authenticate":`License error="${t}", error_description="${s}"`,Link:`<${c}>; rel="license"; type="application/rsl+xml"`}}}function se(){let r={method:"GET"};return globalThis?.fastly&&(r={...r,backend:R}),r}async function $(r,e){try{let n=`${r}/merchants/systems/${e}/license.xml`,t=await fetch(n,se());if(!t.ok)return new Response("License not found",{status:404});let o=await t.text();return new Response(o,{status:200,headers:new Headers({"Content-Type":"application/xml"})})}catch(n){return console.error("[SupertabConnect] hostRSLicenseXML failed:",n),new Response("Bad Gateway",{status:502})}}async function v(r){let e=await A({licenseToken:r.token,requestUrl:r.url,supertabBaseUrl:r.supertabBaseUrl,debug:r.debug}),n=N({apiKey:r.apiKey,baseUrl:r.supertabBaseUrl,eventName:e.valid?"license_used":e.reason,properties:{page_url:r.url,user_agent:r.userAgent,verification_status:e.valid?"valid":"invalid",verification_reason:e.valid?"success":e.reason},licenseId:e.licenseId,debug:r.debug});return r.ctx?.waitUntil&&r.ctx.waitUntil(n),e}async function B(r,e,n){let t=await r.handleRequest(e,n);if(t.action==="block")return new Response(t.body,{status:t.status,headers:new Headers(t.headers)});let o=await fetch(e);if(t.headers){let s=new Response(o.body,o);for(let[c,a]of Object.entries(t.headers))s.headers.set(c,a);return s}return o}async function K(r,e,n,t){if(t&&new URL(e.url).pathname==="/license.xml")return await $(t.baseUrl,t.merchantSystemUrn);let o=await r.handleRequest(e);if(o.action==="block")return new Response(o.body,{status:o.status,headers:new Headers(o.headers)});let s=await fetch(e,{backend:n});if(o.headers){let c=new Response(s.body,s);for(let[a,i]of Object.entries(o.headers))c.headers.set(a,i);return c}return s}async function V(r,e){let n=e.Records[0].cf.request,t=`https://${n.headers.host[0].value}${n.uri}${n.querystring?"?"+n.querystring:""}`,o=new Headers;Object.entries(n.headers).forEach(([a,i])=>{i.forEach(({value:l})=>o.append(a,l))});let s=new Request(t,{method:n.method,headers:o}),c=await r.handleRequest(s);if(c.action==="block"){let a={};return Object.entries(c.headers).forEach(([i,l])=>{a[i.toLowerCase()]=[{key:i,value:l}]}),{status:c.status.toString(),statusDescription:c.status===401?"Unauthorized":"Payment Required",headers:a,body:c.body}}return n}function oe(r){let e=r.headers.get("User-Agent")||"",n=r.headers.get("accept")||"",t=r.headers.get("sec-ch-ua"),o=r.headers.get("accept-language"),s=r.cf?.botManagement?.score,c=["chatgpt-user","perplexitybot","gptbot","anthropic-ai","ccbot","claude-web","claudebot","cohere-ai","youbot","diffbot","oai-searchbot","meta-externalagent","timpibot","amazonbot","bytespider","perplexity-user","googlebot","bot","curl","wget"],a=e.toLowerCase(),i=c.some(h=>a.includes(h)),l=a.includes("headless")||a.includes("puppeteer")||!t,d=!a.includes("headless")&&!a.includes("puppeteer")&&!t,g=!n||!o,f=typeof s=="number"&&s<30;return(a.includes("safari")||a.includes("mozilla"))&&l&&d?!1:i||l||g||f}var u=class u{constructor(e,n=!1){if(!n&&u._instance){if(e.apiKey!==u._instance.apiKey)throw new Error("Cannot create a new instance with different configuration. Use resetInstance to clear the existing instance.");return u._instance}if(n&&u._instance&&u.resetInstance(),!e.apiKey)throw new Error("Missing required configuration: apiKey is required");this.apiKey=e.apiKey,this.enforcement=e.enforcement??"soft",this.botDetector=e.botDetector,this.debug=e.debug??!1,u._instance=this}static resetInstance(){u._instance=null}static setBaseUrl(e){u.baseUrl=e}static getBaseUrl(){return u.baseUrl}static async verify(e){let n=e.baseUrl??u.baseUrl,t=await A({licenseToken:e.token,requestUrl:e.resourceUrl,supertabBaseUrl:n,debug:e.debug??!1});return t.valid?{valid:!0}:{valid:!1,error:t.error}}async verifyAndRecord(e){let n=await v({token:e.token,url:e.resourceUrl,userAgent:e.userAgent??"unknown",supertabBaseUrl:u.baseUrl,debug:e.debug??this.debug,apiKey:this.apiKey,ctx:e.ctx});return n.valid?{valid:!0}:{valid:!1,error:n.error}}async handleRequest(e,n){let t=e.headers.get("Authorization")||"",o=t.startsWith("License ")?t.slice(8):null,s=e.url,c=e.headers.get("User-Agent")||"unknown";if(o){if(this.enforcement==="disabled")return{action:"allow"};let i=await v({token:o,url:s,userAgent:c,supertabBaseUrl:u.baseUrl,debug:this.debug,apiKey:this.apiKey,ctx:n});return i.valid?{action:"allow"}:S({reason:i.reason,error:i.error,requestUrl:s})}if(!(this.botDetector?.(e,n)??!1))return{action:"allow"};switch(this.enforcement){case"strict":return S({reason:"missing_license_token",error:"Authorization header missing or malformed",requestUrl:s});case"soft":return H(s);default:return{action:"allow"}}}static async obtainLicenseToken(e){return q({clientId:e.clientId,clientSecret:e.clientSecret,resourceUrl:e.resourceUrl,debug:e.debug})}static async cloudflareHandleRequests(e,n,t,o){try{let s=new u({apiKey:n.MERCHANT_API_KEY,botDetector:o?.botDetector,enforcement:o?.enforcement});return await B(s,e,t)}catch(s){return console.error("[SupertabConnect] cloudflareHandleRequests failed:",s),await fetch(e)}}static async fastlyHandleRequests(e,n,t,o){try{let{botDetector:s,enforcement:c}=o??{},a=new u({apiKey:n,botDetector:s,enforcement:c}),i;return o?.enableRSL&&(i={baseUrl:u.baseUrl,merchantSystemUrn:o.merchantSystemUrn}),await K(a,e,t,i)}catch(s){return console.error("[SupertabConnect] fastlyHandleRequests failed:",s),await fetch(e,{backend:t})}}static async cloudfrontHandleRequests(e,n){try{let t=new u({apiKey:n.apiKey,botDetector:n.botDetector,enforcement:n.enforcement});return await V(t,e)}catch(t){return console.error("[SupertabConnect] cloudfrontHandleRequests failed:",t),e?.Records?.[0]?.cf?.request??{}}}};u.baseUrl="https://api-connect.supertab.co",u._instance=null;var J=u;export{D as EnforcementMode,w as HandlerAction,J as SupertabConnect,oe as defaultBotDetector};
//# sourceMappingURL=index.js.map