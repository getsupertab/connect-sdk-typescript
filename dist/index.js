var x=(e=>(e.DISABLED="disabled",e.SOFT="soft",e.STRICT="strict",e))(x||{});var g="stc-backend",R=(n=>(n.ALLOW="allow",n.BLOCK="block",n))(R||{});var w=null;function L(){return w||(w=import("jose")),w}async function H(s,t,n){try{let e=await fetch(s,t);if(!e.ok){let o=await e.text().catch(()=>""),i=`Failed to obtain license token: ${e.status} ${e.statusText}${o?` - ${o}`:""}`;throw new Error(i)}let r;try{r=await e.json()}catch(o){throw n&&console.error("Failed to parse license token response as JSON:",o),new Error("Failed to parse license token response as JSON")}if(!r?.access_token)throw new Error("License token response missing access_token");return r.access_token}catch(e){throw n&&console.error("Error generating license token:",e),e}}async function K(s,t){let e=`${new URL(s).origin}/license.xml`,r=await fetch(e);if(!r.ok)throw t&&console.error(`Failed to fetch license.xml from ${e}: ${r.status}`),new Error(`Failed to fetch license.xml from ${e}: ${r.status}`);let o=await r.text();return t&&console.debug("Fetched license.xml from",e),o}function J(s,t){let n=[],e=/<content\s([^>]*)>([\s\S]*?)<\/content>/gi,r=/url\s*=\s*"([^"]*)"/i,o=/server\s*=\s*"([^"]*)"/i,i=/<license[^>]*>[\s\S]*?<\/license>/i,a=0,c;for(;(c=e.exec(s))!==null;){a++;let l=c[1],d=c[2],f=l.match(r),h=l.match(o),m=d.match(i);if(f&&h&&m)n.push({urlPattern:f[1],server:h[1],licenseXml:m[0]});else if(t){let k=[!f&&"url",!h&&"server",!m&&"<license>"].filter(Boolean).join(", ");console.debug(`Skipping <content> element #${a}: missing ${k}`)}}return t&&console.debug(`Found ${a} <content> element(s), ${n.length} valid`),n}function W(s,t,n){let e=new URL(t),r=e.host,o=e.pathname;n&&console.debug(`Matching resource URL: ${t} (host=${r}, path=${o})`);let i=null,a=-1;for(let c of s){let l;try{l=new URL(c.urlPattern)}catch{n&&console.debug(`Skipping block with invalid URL pattern: ${c.urlPattern}`);continue}if(l.host!==r){n&&console.debug(`Skipping block: host mismatch (pattern=${l.host}, resource=${r})`);continue}let d=l.pathname;if(d===o)return n&&console.debug(`Exact match found: ${c.urlPattern}`),c;if(d.endsWith("/*")){let f=d.slice(0,-1);if(o.startsWith(f)){let h=f.length;h>a&&(a=h,i=c)}}}return n&&console.debug(i?`Wildcard match found: ${i.urlPattern} (specificity=${a})`:`No matching content block found for ${t}`),i}async function C({clientId:s,clientSecret:t,resourceUrl:n,debug:e}){let r=await K(n,e);e&&console.debug(`Fetched license.xml (${r.length} chars)`);let o=J(r,e);if(o.length===0)throw e&&console.error("No valid <content> elements with <license> found in license.xml"),new Error("No valid <content> elements with <license> found in license.xml");let i=W(o,n,e);if(!i){if(e){let d=o.map(f=>f.urlPattern).join(", ");console.error(`No <content> element matches resource URL: ${n}. Available patterns: ${d}`)}throw new Error(`No <content> element in license.xml matches resource URL: ${n}`)}e&&(console.debug("Matched content block for resource URL:",n),console.debug("Using license XML:",i.licenseXml));let a=i.server+"/token";e&&console.debug(`Requesting license token from ${a}`);let c=new URLSearchParams({grant_type:"client_credentials",license:i.licenseXml,resource:i.urlPattern}),l={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json",Authorization:"Basic "+btoa(`${s}:${t}`)},body:c.toString()};return H(a,l,e)}var E=new Map;function M(){let s={method:"GET"};return globalThis?.fastly&&(s={...s,backend:g}),s}async function V({cacheKey:s,url:t,debug:n,failureMessage:e,logLabel:r}){if(!E.has(s))try{let o=await fetch(t,M());if(!o.ok)throw new Error(`${e}: ${o.status}`);let i=await o.json();E.set(s,i)}catch(o){throw n&&console.error(r,o),o}return E.get(s)}async function I(s,t){let n=`${s}/.well-known/jwks.json/platform`;return t&&console.debug(`Fetching platform JWKS from URL: ${n}`),V({cacheKey:"platform_jwks",url:n,debug:t,failureMessage:"Failed to fetch platform JWKS",logLabel:"Error fetching platform JWKS:"})}var b=s=>s.trim().replace(/\/+$/,"");async function v({licenseToken:s,requestUrl:t,supertabBaseUrl:n,debug:e}){let{decodeProtectedHeader:r,decodeJwt:o,jwtVerify:i}=await L();if(!s)return{valid:!1,reason:"missing_license_token"};let a;try{a=r(s)}catch(p){return e&&console.error("Invalid license JWT header:",p),{valid:!1,reason:"invalid_license_header"}}if(a.alg!=="ES256")return e&&console.error("Unsupported license JWT alg:",a.alg),{valid:!1,reason:"invalid_license_algorithm"};let c;try{c=o(s)}catch(p){return e&&console.error("Invalid license JWT payload:",p),{valid:!1,reason:"invalid_license_payload"}}let l=c.license_id,d=c.iss,f=d?b(d):void 0,h=b(n);if(!f||!f.startsWith(h))return e&&console.error("License JWT issuer is missing or malformed:",d),{valid:!1,reason:"invalid_license_issuer",licenseId:l};let m=Array.isArray(c.aud)?c.aud.filter(p=>typeof p=="string"):typeof c.aud=="string"?[c.aud]:[],k=b(t);if(!m.some(p=>{let y=b(p);return y?k.startsWith(y):!1}))return e&&console.error("License JWT audience does not match request URL:",c.aud),{valid:!1,reason:"invalid_license_audience",licenseId:l};let T;try{T=await I(n,e)}catch(p){return e&&console.error("Failed to fetch platform JWKS:",p),{valid:!1,reason:"server_error",licenseId:l}}try{let y=await i(s,async A=>{let U=T.keys.find($=>$.kid===A.kid);if(!U)throw new Error(`No matching platform key found: ${A.kid}`);return U},{issuer:d,algorithms:[a.alg],clockTolerance:"1m"});return{valid:!0,licenseId:l,payload:y.payload}}catch(p){return e&&console.error("License JWT verification failed:",p),p instanceof Error&&p.message?.includes("exp")?{valid:!1,reason:"license_token_expired",licenseId:l}:{valid:!1,reason:"license_signature_verification_failed",licenseId:l}}}function _({requestUrl:s}){let t=new URL(s);return`${t.protocol}//${t.host}/license.xml`}function P(s){let t=_({requestUrl:s});return{action:"allow",headers:{Link:`<${t}>; rel="license"; type="application/rsl+xml"`,"X-RSL-Status":"token_required","X-RSL-Reason":"missing"}}}function S({reason:s,requestUrl:t,supertabBaseUrl:n}){let e,r,o;switch(s){case"missing_license_token":o=401,e="invalid_request",r="Authorization header missing or malformed";break;case"invalid_license_algorithm":o=401,e="invalid_request",r="Unsupported token algorithm";break;case"license_token_expired":o=401,e="invalid_token",r="The license token has expired";break;case"license_signature_verification_failed":o=401,e="invalid_token",r="The license token signature is invalid";break;case"invalid_license_header":o=401,e="invalid_token",r="The license token header is malformed";break;case"invalid_license_payload":o=401,e="invalid_token",r="The license token payload is malformed";break;case"invalid_license_issuer":o=401,e="invalid_token",r="The license token issuer is not recognized";break;case"invalid_license_audience":o=403,e="insufficient_scope",r="The license does not grant access to this resource";break;case"server_error":o=503,e="server_error",r="The server encountered an error validating the license";break;default:o=401,e="invalid_token",r="License token missing, expired, revoked, or malformed"}let i=_({requestUrl:t});return{action:"block",status:o,body:`Access to this resource requires a valid license token. Error: ${e} - ${r}`,headers:{"Content-Type":"text/plain; charset=UTF-8","WWW-Authenticate":`License error="${e}", error_description="${r}"`,Link:`<${i}>; rel="license"; type="application/rsl+xml"`}}}function X(){let s={method:"GET"};return globalThis?.fastly&&(s={...s,backend:g}),s}async function q(s,t){let n=`${s}/merchants/systems/${t}/license.xml`,e=await fetch(n,X());if(!e.ok)return new Response("License not found",{status:404});let r=await e.text();return new Response(r,{status:200,headers:new Headers({"Content-Type":"application/xml"})})}async function D(s){let t=await v({licenseToken:s.token,requestUrl:s.url,supertabBaseUrl:s.supertabBaseUrl,debug:s.debug});if(s.recordEvent){let n=t.valid?"license_used":t.reason,e={page_url:s.url,user_agent:s.userAgent,verification_status:t.valid?"valid":"invalid",verification_reason:t.valid?"success":t.reason},r=s.recordEvent(n,e,t.licenseId);s.ctx?.waitUntil&&s.ctx.waitUntil(r)}return t.valid?{action:"allow"}:S({reason:t.reason,requestUrl:s.url,supertabBaseUrl:s.supertabBaseUrl})}async function F(s,t,n){let e=await s.handleRequest(t,n);if(e.action==="block")return new Response(e.body,{status:e.status,headers:new Headers(e.headers)});let r=await fetch(t);if(e.headers){let o=new Response(r.body,r);for(let[i,a]of Object.entries(e.headers))o.headers.set(i,a);return o}return r}async function B(s,t,n,e){if(e&&new URL(t.url).pathname==="/license.xml")return await q(e.baseUrl,e.merchantSystemUrn);let r=await s.handleRequest(t);if(r.action==="block")return new Response(r.body,{status:r.status,headers:new Headers(r.headers)});let o=await fetch(t,{backend:n});if(r.headers){let i=new Response(o.body,o);for(let[a,c]of Object.entries(r.headers))i.headers.set(a,c);return i}return o}async function N(s,t){let n=t.Records[0].cf.request,e=`https://${n.headers.host[0].value}${n.uri}${n.querystring?"?"+n.querystring:""}`,r=new Headers;Object.entries(n.headers).forEach(([a,c])=>{c.forEach(({value:l})=>r.append(a,l))});let o=new Request(e,{method:n.method,headers:r}),i=await s.handleRequest(o);if(i.action==="block"){let a={};return Object.entries(i.headers).forEach(([c,l])=>{a[c.toLowerCase()]=[{key:c,value:l}]}),{status:i.status.toString(),statusDescription:i.status===401?"Unauthorized":"Payment Required",headers:a,body:i.body}}return n}function G(s){let t=s.headers.get("User-Agent")||"",n=s.headers.get("accept")||"",e=s.headers.get("sec-ch-ua"),r=s.headers.get("accept-language"),o=s.cf?.botManagement?.score,i=["chatgpt-user","perplexitybot","gptbot","anthropic-ai","ccbot","claude-web","claudebot","cohere-ai","youbot","diffbot","oai-searchbot","meta-externalagent","timpibot","amazonbot","bytespider","perplexity-user","googlebot","bot","curl","wget"],a=t.toLowerCase(),c=i.some(m=>a.includes(m)),l=t.toLowerCase().includes("headless")||t.toLowerCase().includes("puppeteer")||!e,d=!t.toLowerCase().includes("headless")&&!t.toLowerCase().includes("puppeteer")&&!e,f=!n||!r,h=typeof o=="number"&&o<30;return(a.includes("safari")||a.includes("mozilla"))&&l&&d?!1:c||l||f||h}var u=class u{constructor(t,n=!1){if(!n&&u._instance){if(!(t.apiKey===u._instance.apiKey&&t.merchantSystemUrn===u._instance.merchantSystemUrn))throw new Error("Cannot create a new instance with different configuration. Use resetInstance to clear the existing instance.");return u._instance}if(n&&u._instance&&u.resetInstance(),!t.apiKey||!t.merchantSystemUrn)throw new Error("Missing required configuration: apiKey and merchantSystemUrn are required");this.apiKey=t.apiKey,this.merchantSystemUrn=t.merchantSystemUrn,this.enforcement=t.enforcement??"soft",this.botDetector=t.botDetector,this.debug=t.debug??!1,u._instance=this}static resetInstance(){u._instance=null}static setBaseUrl(t){u.baseUrl=t}static getBaseUrl(){return u.baseUrl}async verifyLicenseToken(t,n){return v({licenseToken:t,requestUrl:n,supertabBaseUrl:u.baseUrl,debug:this.debug})}async recordEvent(t,n={},e){let r={event_name:t,merchant_system_urn:this.merchantSystemUrn?this.merchantSystemUrn:"",license_id:e,properties:n};try{let o={method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(r)};globalThis?.fastly&&(o={...o,backend:g});let i=await fetch(`${u.baseUrl}/events`,o);i.ok||console.log(`Failed to record event: ${i.status}`)}catch(o){console.log("Error recording event:",o)}}async handleRequest(t,n){let e=t.headers.get("Authorization")||"",r=e.startsWith("License ")?e.slice(8):null,o=t.url,i=t.headers.get("User-Agent")||"unknown";if(r)return this.enforcement==="disabled"?{action:"allow"}:D({token:r,url:o,userAgent:i,supertabBaseUrl:u.baseUrl,debug:this.debug,recordEvent:this.recordEvent.bind(this),ctx:n});if(!(this.botDetector?.(t,n)??!1))return{action:"allow"};switch(this.enforcement){case"strict":return S({reason:"missing_license_token",requestUrl:o,supertabBaseUrl:u.baseUrl});case"soft":return P(o);default:return{action:"allow"}}}static async obtainLicenseToken(t,n,e,r=!1){return C({clientId:t,clientSecret:n,resourceUrl:e,debug:r})}static async cloudflareHandleRequests(t,n,e){let r=new u({apiKey:n.MERCHANT_API_KEY,merchantSystemUrn:n.MERCHANT_SYSTEM_URN});return F(r,t,e)}static async fastlyHandleRequests(t,n,e,r,o){let{enableRSL:i=!1,botDetector:a,enforcement:c}=o??{},l=new u({apiKey:e,merchantSystemUrn:n,botDetector:a,enforcement:c});return B(l,t,r,i?{baseUrl:u.baseUrl,merchantSystemUrn:n}:void 0)}static async cloudfrontHandleRequests(t,n){let e=new u({apiKey:n.apiKey,merchantSystemUrn:n.merchantSystemUrn,botDetector:n.botDetector,enforcement:n.enforcement});return N(e,t)}};u.baseUrl="https://api-connect.supertab.co",u._instance=null;var O=u;export{x as EnforcementMode,R as HandlerAction,O as SupertabConnect,G as defaultBotDetector};
//# sourceMappingURL=index.js.map