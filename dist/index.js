"use strict";var m=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var b=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var R=(d,e)=>{for(var t in e)m(d,t,{get:e[t],enumerable:!0})},I=(d,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of b(e))!E.call(d,r)&&r!==t&&m(d,r,{get:()=>e[r],enumerable:!(s=_(e,r))||s.enumerable});return d};var S=d=>I(m({},"__esModule",{value:!0}),d);var A={};R(A,{SupertabConnect:()=>w});module.exports=S(A);var y=require("jose"),f=new Map,h=!0,a=class a{constructor(e,t=!1){if(!t&&a._instance){if(!(e.apiKey===a._instance.apiKey&&e.merchantSystemUrn===a._instance.merchantSystemUrn))throw new Error("Cannot create a new instance with different configuration. Use resetInstance to clear the existing instance.");return a._instance}if(t&&a._instance&&a.resetInstance(),!e.apiKey||!e.merchantSystemUrn)throw new Error("Missing required configuration: apiKey and merchantSystemUrn are required");this.apiKey=e.apiKey,this.merchantSystemUrn=e.merchantSystemUrn,this.baseUrl="https://api-connect.sbx.supertab.co",a._instance=this}static resetInstance(){a._instance=null}async getJwksForIssuer(e){if(!f.has(e)){let t=`${this.baseUrl}/.well-known/jwks.json/${encodeURIComponent(e)}`;try{let s=await fetch(t);if(!s.ok)throw new Error(`Failed to fetch JWKS: ${s.status}`);let r=await s.json();f.set(e,r)}catch(s){throw h&&console.error("Error fetching JWKS:",s),s}}return f.get(e)}async verifyToken(e){if(!e)return{valid:!1,reason:"missing_token"};let t;try{t=(0,y.decodeProtectedHeader)(e)}catch(n){return h&&console.error("Invalid JWT header:",n),{valid:!1,reason:"invalid_header"}}if(t.alg!=="RS256")return{valid:!1,reason:"invalid_algorithm"};let s;try{s=(0,y.decodeJwt)(e)}catch(n){return h&&console.error("Invalid JWT payload:",n),{valid:!1,reason:"invalid_payload"}}let r=s.iss;if(!r||!r.startsWith("urn:stc:customer:"))return{valid:!1,reason:"invalid_issuer"};try{let n=await this.getJwksForIssuer(r);return{valid:!0,payload:(await(0,y.jwtVerify)(e,async l=>{let i=n.keys.find(c=>c.kid===l.kid);if(!i)throw new Error(`No matching key found: ${l.kid}`);return i},{issuer:r,algorithms:["RS256"],clockTolerance:"1m"})).payload}}catch(n){return h&&console.error("JWT verification failed:",n),n.message?.includes("exp")?{valid:!1,reason:"token_expired"}:{valid:!1,reason:"signature_verification_failed"}}}async recordEvent(e,t,s={}){let r={event_name:e,customer_system_token:t,merchant_system_urn:this.merchantSystemUrn?this.merchantSystemUrn:"",properties:s};try{let n=await fetch(`${this.baseUrl}/events`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(r)});n.ok||console.log(`Failed to record event: ${n.status}`)}catch(n){console.log("Error recording event:",n)}}async baseHandleRequest(e,t,s,r){let n=await this.verifyToken(e);async function o(u,l,i){let c={page_url:t,user_agent:s,verification_status:n.valid?"valid":"invalid",verification_reason:n.reason||"success"};if(i){let p=u.recordEvent(l,e,c);return i.waitUntil(p),p}else return await u.recordEvent(l,e,c)}if(!n.valid){await o(this,n.reason||"token_verification_failed",r);let u="Payment required: you need to present a valid Supertab Connect token to access this content. Check out the provided url for details",l="\u274C Content access denied"+(n.reason?`: ${n.reason}`:""),c={url:`${this.baseUrl}/merchants/systems/${this.merchantSystemUrn}/content-access.json`,message:u,details:l};return new Response(JSON.stringify(c),{status:402,headers:new Headers({"Content-Type":"application/json"})})}return await o(this,"page_viewed",r),new Response("\u2705 Content Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})})}extractDataFromRequest(e){let t=e.headers.get("Authorization")||"",s=t.startsWith("Bearer ")?t.slice(7):"",r=e.url,n=e.headers.get("User-Agent")||"unknown";return{token:s,url:r,user_agent:n}}static checkIfBotRequest(e){let t=e.headers.get("User-Agent")||"",s=e.headers.get("accept")||"",r=e.headers.get("sec-ch-ua"),n=e.headers.get("accept-language"),o=e.cf?.botManagement?.score,u=["chatgpt-user","perplexitybot","gptbot","anthropic-ai","ccbot","claude-web","claudebot","cohere-ai","youbot","diffbot","oai-searchbot","meta-externalagent","timpibot","amazonbot","bytespider","perplexity-user","googlebot","bot","curl","wget"],l=t.toLowerCase(),i=u.some(v=>l.includes(v)),c=t.toLowerCase().includes("headless")||t.toLowerCase().includes("puppeteer")||!r,p=!s||!n,g=typeof o=="number"&&o<30;return console.log("Bot Detection Details:",{botUaMatch:i,headlessIndicators:c,missingHeaders:p,lowBotScore:g,botScore:o}),a._instance&&a._instance.recordEvent("debug_bot_detected",void 0,{userAgent:t,botUaMatch:i,headlessIndicators:c,missingHeaders:p,lowBotScore:g,botScore:o}),i||c||p||g}static async cloudflareHandleRequests(e,t,s){let{MERCHANT_SYSTEM_URN:r,MERCHANT_API_KEY:n}=t;return new a({apiKey:n,merchantSystemUrn:r}).handleRequest(e,a.checkIfBotRequest,s)}static async fastlyHandleRequests(e,t,s){return new a({apiKey:s,merchantSystemUrn:t}).handleRequest(e,a.checkIfBotRequest,null)}async handleRequest(e,t,s){let{token:r,url:n,user_agent:o}=this.extractDataFromRequest(e);return t&&!t(e,s)?new Response("\u2705 Non-Bot Content Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})}):this.baseHandleRequest(r,n,o,s)}};a._instance=null;var w=a;0&&(module.exports={SupertabConnect});
//# sourceMappingURL=index.js.map