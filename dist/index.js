"use strict";var I=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var C=Object.prototype.hasOwnProperty;var D=(a,e)=>{for(var t in e)I(a,t,{get:e[t],enumerable:!0})},J=(a,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of N(e))!C.call(a,s)&&s!==t&&I(a,s,{get:()=>e[s],enumerable:!(n=U(e,s))||n.enumerable});return a};var x=a=>J(I({},"__esModule",{value:!0}),a);var F={};D(F,{SupertabConnect:()=>k});module.exports=x(F);var _=require("jose");var m=require("jose");async function H(a,e){let t=["RS256","ES256"];for(let n of t)try{return{key:await(0,m.importPKCS8)(a,n),alg:n}}catch(s){e&&console.debug(`Private key did not import using ${n}, retrying...`,s)}throw new Error("Unsupported private key format. Expected RSA or P-256 EC private key.")}async function v({clientId:a,privateKeyPem:e,tokenEndpoint:t,resourceUrl:n,licenseXml:s,debug:r}){let{key:o,alg:l}=await H(e,r),c=Math.floor(Date.now()/1e3),g=await new m.SignJWT({}).setProtectedHeader({alg:l}).setIssuer(a).setSubject(a).setIssuedAt(c).setExpirationTime(c+300).setAudience(t).sign(o),i=new URLSearchParams({grant_type:"rsl",client_assertion_type:"urn:ietf:params:oauth:client-assertion-type:jwt-bearer",client_assertion:g,license:s,resource:n}),d={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:i.toString()};try{let p=await fetch(t,d);if(!p.ok){let f=await p.text().catch(()=>""),E=`Failed to obtain license token: ${p.status} ${p.statusText}${f?` - ${f}`:""}`;throw new Error(E)}let y;try{y=await p.json()}catch(f){throw r&&console.error("Failed to parse license token response as JSON:",f),new Error("Failed to parse license token response as JSON")}if(!y?.access_token)throw new Error("License token response missing access_token");return y.access_token}catch(p){throw r&&console.error("Error generating license token:",p),p}}async function S({customerURN:a,kid:e,privateKeyPem:t,expirationSeconds:n=3600}){let s="RS256",r=await(0,m.importPKCS8)(t,s),o=Math.floor(Date.now()/1e3);return new m.SignJWT({}).setProtectedHeader({alg:s,kid:e}).setIssuer(a).setIssuedAt(o).setExpirationTime(o+n).sign(r)}var h=require("jose");var A=new Map,q="sbx-backend";function V(){let a={method:"GET"};return globalThis?.fastly&&(a={...a,backend:q}),a}async function R({cacheKey:a,url:e,debug:t,failureMessage:n,logLabel:s}){if(!A.has(a))try{let r=await fetch(e,V());if(!r.ok)throw new Error(`${n}: ${r.status}`);let o=await r.json();A.set(a,o)}catch(r){throw t&&console.error(s,r),r}return A.get(a)}async function T(a,e,t){let n=`${a}/.well-known/jwks.json/${encodeURIComponent(e)}`;return R({cacheKey:e,url:n,debug:t,failureMessage:"Failed to fetch JWKS",logLabel:"Error fetching JWKS:"})}async function b(a,e){let t=`${a}/.well-known/.well-known/jwks.json`;return R({cacheKey:"platform_jwks",url:t,debug:e,failureMessage:"Failed to fetch platform JWKS",logLabel:"Error fetching platform JWKS:"})}var P=a=>a.replace(/\/+$/,"");async function W({licenseToken:a,requestUrl:e,supertabBaseUrl:t,debug:n}){if(!a)return{valid:!1,reason:"missing_license_token"};let s;try{s=(0,h.decodeProtectedHeader)(a)}catch(i){return n&&console.error("Invalid license JWT header:",i),{valid:!1,reason:"invalid_license_header"}}if(s.alg!=="ES256")return n&&console.error("Unsupported license JWT alg:",s.alg),{valid:!1,reason:"invalid_license_algorithm"};let r;try{r=(0,h.decodeJwt)(a)}catch(i){return n&&console.error("Invalid license JWT payload:",i),{valid:!1,reason:"invalid_license_payload"}}let o=r.iss;if(!o||!o.startsWith(t))return n&&console.error("Invalid license JWT issuer:",o),{valid:!1,reason:"invalid_license_issuer"};let l=Array.isArray(r.aud)?r.aud.filter(i=>typeof i=="string"):typeof r.aud=="string"?[r.aud]:[],c=P(e);if(!l.some(i=>{let d=P(i);return d?c.startsWith(d):!1}))return n&&console.error("License JWT audience does not match request URL:",r.aud),{valid:!1,reason:"invalid_license_audience"};try{let i=await b(t,n);return{valid:!0,payload:(await(0,h.jwtVerify)(a,async y=>{let f=i.keys.find(E=>E.kid===y.kid);if(!f)throw new Error(`No matching platform key found: ${y.kid}`);return f},{issuer:o,algorithms:[s.alg],clockTolerance:"1m"})).payload}}catch(i){return n&&console.error("License JWT verification failed:",i),i instanceof Error&&i.message?.includes("exp")?{valid:!1,reason:"license_token_expired"}:{valid:!1,reason:"license_signature_verification_failed"}}}function K({supertabBaseUrl:a,merchantSystemUrn:e}){return`${a}/merchants/systems/${e}/license.xml`}async function L({licenseToken:a,url:e,userAgent:t,ctx:n,supertabBaseUrl:s,merchantSystemUrn:r,debug:o,recordEvent:l}){let c=await W({licenseToken:a,requestUrl:e,supertabBaseUrl:s,debug:o});async function g(i){let d={page_url:e,user_agent:t,verification_status:c.valid?"valid":"invalid",verification_reason:c.reason||"success"},p=l(i,void 0,a,d);return n?.waitUntil&&n.waitUntil(p),p}if(!c.valid){await g(c.reason||"license_token_verification_failed");let i="invalid_request",d="Access to this resource requires a license";switch(c.reason){case"missing_license_token":i="invalid_request",d="Access to this resource requires a license";break;case"license_token_expired":i="invalid_token",d="The license token has expired";break;case"license_signature_verification_failed":case"invalid_license_header":case"invalid_license_payload":i="invalid_token",d="The license token is invalid";break;case"invalid_license_issuer":case"invalid_license_audience":i="insufficient_scope",d="The license token is not valid for this resource";break;default:i="invalid_request",d="Access to this resource requires a license"}let p=K({supertabBaseUrl:s,merchantSystemUrn:r}),y=`${s}/docs/errors#${i}`,f=new Headers({"Content-Type":"text/plain; charset=UTF-8","WWW-Authenticate":`License error="${i}", error_description="${d}", error_uri="${y}"`,Link:`${p}; rel="license"; type="application/rsl+xml"`}),E=`Access to this resource requires a valid license token. Error: ${i} - ${d}`;return new Response(E,{status:401,headers:f})}return await g("license_used"),new Response("\u2705 License Token Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})})}var w=!0,u=class u{constructor(e,t=!1){if(!t&&u._instance){if(!(e.apiKey===u._instance.apiKey&&e.merchantSystemUrn===u._instance.merchantSystemUrn))throw new Error("Cannot create a new instance with different configuration. Use resetInstance to clear the existing instance.");return u._instance}if(t&&u._instance&&u.resetInstance(),!e.apiKey||!e.merchantSystemUrn)throw new Error("Missing required configuration: apiKey and merchantSystemUrn are required");this.apiKey=e.apiKey,this.merchantSystemUrn=e.merchantSystemUrn,u._instance=this}static resetInstance(){u._instance=null}static setBaseUrl(e){u.baseUrl=e}async verifyToken(e){if(!e)return{valid:!1,reason:"missing_token"};let t;try{t=(0,_.decodeProtectedHeader)(e)}catch(r){return w&&console.error("Invalid JWT header:",r),{valid:!1,reason:"invalid_header"}}if(t.alg!=="RS256")return{valid:!1,reason:"invalid_algorithm"};let n;try{n=(0,_.decodeJwt)(e)}catch(r){return w&&console.error("Invalid JWT payload:",r),{valid:!1,reason:"invalid_payload"}}let s=n.iss;if(!s||!s.startsWith("urn:stc:customer:"))return{valid:!1,reason:"invalid_issuer"};try{let r=await T(u.baseUrl,s,w);return{valid:!0,payload:(await(0,_.jwtVerify)(e,async c=>{let g=r.keys.find(i=>i.kid===c.kid);if(!g)throw new Error(`No matching key found: ${c.kid}`);return g},{issuer:s,algorithms:["RS256"],clockTolerance:"1m"})).payload}}catch(r){return w&&console.error("JWT verification failed:",r),r.message?.includes("exp")?{valid:!1,reason:"token_expired"}:{valid:!1,reason:"signature_verification_failed"}}}async recordEvent(e,t,n,s={}){let r={event_name:e,customer_system_token:t,license_token:n,merchant_system_urn:this.merchantSystemUrn?this.merchantSystemUrn:"",properties:s};try{let o={method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(r)};globalThis?.fastly&&(o={...o,backend:"sbx-backend"});let l=await fetch(`${u.baseUrl}/events`,o);l.ok||console.log(`Failed to record event: ${l.status}`)}catch(o){console.log("Error recording event:",o)}}async baseHandleRequest(e,t,n,s){let r=await this.verifyToken(e);async function o(l,c,g){let i={page_url:t,user_agent:n,verification_status:r.valid?"valid":"invalid",verification_reason:r.reason||"success"};if(g){let d=l.recordEvent(c,e,void 0,i);return g.waitUntil(d),d}else return await l.recordEvent(c,e,void 0,i)}if(!r.valid){await o(this,r.reason||"token_verification_failed",s);let l="Payment required: you need to present a valid Supertab Connect token to access this content. Check out the provided url for details",c="\u274C Content access denied"+(r.reason?`: ${r.reason}`:""),i={url:`${u.baseUrl}/merchants/systems/${this.merchantSystemUrn}/content-access.json`,message:l,details:c};return new Response(JSON.stringify(i),{status:402,headers:new Headers({"Content-Type":"application/json"})})}return await o(this,"page_viewed",s),new Response("\u2705 Content Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})})}async baseLicenseHandleRequest(e,t,n,s){return L({licenseToken:e,url:t,userAgent:n,ctx:s,supertabBaseUrl:u.baseUrl,merchantSystemUrn:this.merchantSystemUrn,debug:w,recordEvent:(r,o,l,c)=>this.recordEvent(r,o,l,c)})}extractDataFromRequest(e){let t=e.headers.get("Authorization")||"",n=t.startsWith("Bearer ")?t.slice(7):"",s=t.startsWith("License ")?t.slice(8):"",r=e.url,o=e.headers.get("User-Agent")||"unknown";return{token:n,licenseToken:s,url:r,user_agent:o}}static checkIfBotRequest(e){let t=e.headers.get("User-Agent")||"",n=e.headers.get("accept")||"",s=e.headers.get("sec-ch-ua"),r=e.headers.get("accept-language"),o=e.cf?.botManagement?.score,l=["chatgpt-user","perplexitybot","gptbot","anthropic-ai","ccbot","claude-web","claudebot","cohere-ai","youbot","diffbot","oai-searchbot","meta-externalagent","timpibot","amazonbot","bytespider","perplexity-user","googlebot","bot","curl","wget"],c=t.toLowerCase(),g=l.some(f=>c.includes(f)),i=t.toLowerCase().includes("headless")||t.toLowerCase().includes("puppeteer")||!s,d=!t.toLowerCase().includes("headless")||!t.toLowerCase().includes("puppeteer")||!s,p=!n||!r,y=typeof o=="number"&&o<30;return console.log("Bot Detection Details:",{botUaMatch:g,headlessIndicators:i,missingHeaders:p,lowBotScore:y,botScore:o}),(c.includes("safari")||c.includes("mozilla"))&&i&&d?!1:g||i||p||y}static async cloudflareHandleRequests(e,t,n){let{MERCHANT_SYSTEM_URN:s,MERCHANT_API_KEY:r}=t;return new u({apiKey:r,merchantSystemUrn:s}).handleRequest(e,u.checkIfBotRequest,n)}static async fastlyHandleRequests(e,t,n){return new u({apiKey:n,merchantSystemUrn:t}).handleRequest(e,u.checkIfBotRequest,null)}async handleRequest(e,t,n){let{token:s,licenseToken:r,url:o,user_agent:l}=this.extractDataFromRequest(e);return t&&!t(e,n)?new Response("\u2705 Non-Bot Content Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})}):s?this.baseHandleRequest(s,o,l,n):this.baseLicenseHandleRequest(r,o,l,n)}static async generateLicenseToken(e,t,n,s,r){return v({clientId:e,privateKeyPem:t,tokenEndpoint:n,resourceUrl:s,licenseXml:r,debug:w})}static async generateCustomerJWT(e,t,n,s=3600){return S({customerURN:e,kid:t,privateKeyPem:n,expirationSeconds:s})}};u.baseUrl="https://api-connect.sbx.supertab.co",u._instance=null;var k=u;0&&(module.exports={SupertabConnect});
//# sourceMappingURL=index.js.map