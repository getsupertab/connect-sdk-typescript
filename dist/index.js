"use strict";var I=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var D=Object.prototype.hasOwnProperty;var J=(i,e)=>{for(var t in e)I(i,t,{get:e[t],enumerable:!0})},x=(i,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of C(e))!D.call(i,s)&&s!==t&&I(i,s,{get:()=>e[s],enumerable:!(r=N(e,s))||r.enumerable});return i};var H=i=>x(I({},"__esModule",{value:!0}),i);var $={};J($,{SupertabConnect:()=>k});module.exports=H($);var E=require("jose");var h=require("jose");async function q(i,e){let t=["RS256","ES256"];for(let r of t)try{return{key:await(0,h.importPKCS8)(i,r),alg:r}}catch(s){e&&console.debug(`Private key did not import using ${r}, retrying...`,s)}throw new Error("Unsupported private key format. Expected RSA or P-256 EC private key.")}async function v({clientId:i,kid:e,privateKeyPem:t,tokenEndpoint:r,resourceUrl:s,licenseXml:n,debug:a}){let{key:l,alg:c}=await q(t,a),p=Math.floor(Date.now()/1e3),o=await new h.SignJWT({}).setProtectedHeader({alg:c,kid:e}).setIssuer(i).setSubject(i).setIssuedAt(p).setExpirationTime(p+300).setAudience(r).sign(l),d=new URLSearchParams({grant_type:"rsl",client_assertion_type:"urn:ietf:params:oauth:client-assertion-type:jwt-bearer",client_assertion:o,license:n,resource:s}),y={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:d.toString()};try{let g=await fetch(r,y);if(!g.ok){let m=await g.text().catch(()=>""),U=`Failed to obtain license token: ${g.status} ${g.statusText}${m?` - ${m}`:""}`;throw new Error(U)}let f;try{f=await g.json()}catch(m){throw a&&console.error("Failed to parse license token response as JSON:",m),new Error("Failed to parse license token response as JSON")}if(!f?.access_token)throw new Error("License token response missing access_token");return f.access_token}catch(g){throw a&&console.error("Error generating license token:",g),g}}async function S({customerURN:i,kid:e,privateKeyPem:t,expirationSeconds:r=3600}){let s="RS256",n=await(0,h.importPKCS8)(t,s),a=Math.floor(Date.now()/1e3);return new h.SignJWT({}).setProtectedHeader({alg:s,kid:e}).setIssuer(i).setIssuedAt(a).setExpirationTime(a+r).sign(n)}var w=require("jose");var A=new Map,V="sbx-backend";function W(){let i={method:"GET"};return globalThis?.fastly&&(i={...i,backend:V}),i}async function R({cacheKey:i,url:e,debug:t,failureMessage:r,logLabel:s}){if(!A.has(i))try{let n=await fetch(e,W());if(!n.ok)throw new Error(`${r}: ${n.status}`);let a=await n.json();A.set(i,a)}catch(n){throw t&&console.error(s,n),n}return A.get(i)}async function T(i,e,t){let r=`${i}/.well-known/jwks.json/${encodeURIComponent(e)}`;return R({cacheKey:e,url:r,debug:t,failureMessage:"Failed to fetch JWKS",logLabel:"Error fetching JWKS:"})}async function b(i,e){let t=`${i}/.well-known/.well-known/jwks.json`;return R({cacheKey:"platform_jwks",url:t,debug:e,failureMessage:"Failed to fetch platform JWKS",logLabel:"Error fetching platform JWKS:"})}var P=i=>i.replace(/\/+$/,"");async function K({licenseToken:i,requestUrl:e,supertabBaseUrl:t,debug:r}){if(!i)return{valid:!1,reason:"missing_license_token"};let s;try{s=(0,w.decodeProtectedHeader)(i)}catch(o){return r&&console.error("Invalid license JWT header:",o),{valid:!1,reason:"invalid_license_header"}}if(s.alg!=="ES256")return r&&console.error("Unsupported license JWT alg:",s.alg),{valid:!1,reason:"invalid_license_algorithm"};let n;try{n=(0,w.decodeJwt)(i)}catch(o){return r&&console.error("Invalid license JWT payload:",o),{valid:!1,reason:"invalid_license_payload"}}let a=n.iss;if(!a||!a.startsWith(t))return r&&console.error("Invalid license JWT issuer:",a),{valid:!1,reason:"invalid_license_issuer"};let l=Array.isArray(n.aud)?n.aud.filter(o=>typeof o=="string"):typeof n.aud=="string"?[n.aud]:[],c=P(e);if(!l.some(o=>{let d=P(o);return d?c.startsWith(d):!1}))return r&&console.error("License JWT audience does not match request URL:",n.aud),{valid:!1,reason:"invalid_license_audience"};try{let o=await b(t,r);return{valid:!0,payload:(await(0,w.jwtVerify)(i,async g=>{let f=o.keys.find(m=>m.kid===g.kid);if(!f)throw new Error(`No matching platform key found: ${g.kid}`);return f},{issuer:a,algorithms:[s.alg],clockTolerance:"1m"})).payload}}catch(o){return r&&console.error("License JWT verification failed:",o),o instanceof Error&&o.message?.includes("exp")?{valid:!1,reason:"license_token_expired"}:{valid:!1,reason:"license_signature_verification_failed"}}}function F({supertabBaseUrl:i,merchantSystemUrn:e}){return`${i}/merchants/systems/${e}/license.xml`}async function L({licenseToken:i,url:e,userAgent:t,ctx:r,supertabBaseUrl:s,merchantSystemUrn:n,debug:a,recordEvent:l}){let c=await K({licenseToken:i,requestUrl:e,supertabBaseUrl:s,debug:a});async function p(o){let d={page_url:e,user_agent:t,verification_status:c.valid?"valid":"invalid",verification_reason:c.reason||"success"},y=l(o,void 0,i,d);return r?.waitUntil&&r.waitUntil(y),y}if(!c.valid){await p(c.reason||"license_token_verification_failed");let o="invalid_request",d="Access to this resource requires a license";switch(c.reason){case"missing_license_token":o="invalid_request",d="Access to this resource requires a license";break;case"license_token_expired":o="invalid_token",d="The license token has expired";break;case"license_signature_verification_failed":case"invalid_license_header":case"invalid_license_payload":o="invalid_token",d="The license token is invalid";break;case"invalid_license_issuer":case"invalid_license_audience":o="insufficient_scope",d="The license token is not valid for this resource";break;default:o="invalid_request",d="Access to this resource requires a license"}let y=F({supertabBaseUrl:s,merchantSystemUrn:n}),g=`${s}/docs/errors#${o}`,f=new Headers({"Content-Type":"text/plain; charset=UTF-8","WWW-Authenticate":`License error="${o}", error_description="${d}", error_uri="${g}"`,Link:`${y}; rel="license"; type="application/rsl+xml"`}),m=`Access to this resource requires a valid license token. Error: ${o} - ${d}`;return new Response(m,{status:401,headers:f})}return await p("license_used"),new Response("\u2705 License Token Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})})}var _=!0,u=class u{constructor(e,t=!1){if(!t&&u._instance){if(!(e.apiKey===u._instance.apiKey&&e.merchantSystemUrn===u._instance.merchantSystemUrn))throw new Error("Cannot create a new instance with different configuration. Use resetInstance to clear the existing instance.");return u._instance}if(t&&u._instance&&u.resetInstance(),!e.apiKey||!e.merchantSystemUrn)throw new Error("Missing required configuration: apiKey and merchantSystemUrn are required");this.apiKey=e.apiKey,this.merchantSystemUrn=e.merchantSystemUrn,u._instance=this}static resetInstance(){u._instance=null}static setBaseUrl(e){u.baseUrl=e}async verifyToken(e){if(!e)return{valid:!1,reason:"missing_token"};let t;try{t=(0,E.decodeProtectedHeader)(e)}catch(n){return _&&console.error("Invalid JWT header:",n),{valid:!1,reason:"invalid_header"}}if(t.alg!=="RS256")return{valid:!1,reason:"invalid_algorithm"};let r;try{r=(0,E.decodeJwt)(e)}catch(n){return _&&console.error("Invalid JWT payload:",n),{valid:!1,reason:"invalid_payload"}}let s=r.iss;if(!s||!s.startsWith("urn:stc:customer:"))return{valid:!1,reason:"invalid_issuer"};try{let n=await T(u.baseUrl,s,_);return{valid:!0,payload:(await(0,E.jwtVerify)(e,async c=>{let p=n.keys.find(o=>o.kid===c.kid);if(!p)throw new Error(`No matching key found: ${c.kid}`);return p},{issuer:s,algorithms:["RS256"],clockTolerance:"1m"})).payload}}catch(n){return _&&console.error("JWT verification failed:",n),n.message?.includes("exp")?{valid:!1,reason:"token_expired"}:{valid:!1,reason:"signature_verification_failed"}}}async recordEvent(e,t,r,s={}){let n={event_name:e,customer_system_token:t,license_token:r,merchant_system_urn:this.merchantSystemUrn?this.merchantSystemUrn:"",properties:s};try{let a={method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(n)};globalThis?.fastly&&(a={...a,backend:"sbx-backend"});let l=await fetch(`${u.baseUrl}/events`,a);l.ok||console.log(`Failed to record event: ${l.status}`)}catch(a){console.log("Error recording event:",a)}}async baseHandleRequest(e,t,r,s){let n=await this.verifyToken(e);async function a(l,c,p){let o={page_url:t,user_agent:r,verification_status:n.valid?"valid":"invalid",verification_reason:n.reason||"success"};if(p){let d=l.recordEvent(c,e,void 0,o);return p.waitUntil(d),d}else return await l.recordEvent(c,e,void 0,o)}if(!n.valid){await a(this,n.reason||"token_verification_failed",s);let l="Payment required: you need to present a valid Supertab Connect token to access this content. Check out the provided url for details",c="\u274C Content access denied"+(n.reason?`: ${n.reason}`:""),o={url:`${u.baseUrl}/merchants/systems/${this.merchantSystemUrn}/content-access.json`,message:l,details:c};return new Response(JSON.stringify(o),{status:402,headers:new Headers({"Content-Type":"application/json"})})}return await a(this,"page_viewed",s),new Response("\u2705 Content Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})})}async baseLicenseHandleRequest(e,t,r,s){return L({licenseToken:e,url:t,userAgent:r,ctx:s,supertabBaseUrl:u.baseUrl,merchantSystemUrn:this.merchantSystemUrn,debug:_,recordEvent:(n,a,l,c)=>this.recordEvent(n,a,l,c)})}extractDataFromRequest(e){let t=e.headers.get("Authorization")||"",r=t.startsWith("Bearer ")?t.slice(7):"",s=t.startsWith("License ")?t.slice(8):"",n=e.url,a=e.headers.get("User-Agent")||"unknown";return{token:r,licenseToken:s,url:n,user_agent:a}}static checkIfBotRequest(e){let t=e.headers.get("User-Agent")||"",r=e.headers.get("accept")||"",s=e.headers.get("sec-ch-ua"),n=e.headers.get("accept-language"),a=e.cf?.botManagement?.score,l=["chatgpt-user","perplexitybot","gptbot","anthropic-ai","ccbot","claude-web","claudebot","cohere-ai","youbot","diffbot","oai-searchbot","meta-externalagent","timpibot","amazonbot","bytespider","perplexity-user","googlebot","bot","curl","wget"],c=t.toLowerCase(),p=l.some(f=>c.includes(f)),o=t.toLowerCase().includes("headless")||t.toLowerCase().includes("puppeteer")||!s,d=!t.toLowerCase().includes("headless")||!t.toLowerCase().includes("puppeteer")||!s,y=!r||!n,g=typeof a=="number"&&a<30;return console.log("Bot Detection Details:",{botUaMatch:p,headlessIndicators:o,missingHeaders:y,lowBotScore:g,botScore:a}),(c.includes("safari")||c.includes("mozilla"))&&o&&d?!1:p||o||y||g}static async cloudflareHandleRequests(e,t,r){let{MERCHANT_SYSTEM_URN:s,MERCHANT_API_KEY:n}=t;return new u({apiKey:n,merchantSystemUrn:s}).handleRequest(e,u.checkIfBotRequest,r)}static async fastlyHandleRequests(e,t,r){return new u({apiKey:r,merchantSystemUrn:t}).handleRequest(e,u.checkIfBotRequest,null)}async handleRequest(e,t,r){let{token:s,licenseToken:n,url:a,user_agent:l}=this.extractDataFromRequest(e);return t&&!t(e,r)?new Response("\u2705 Non-Bot Content Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})}):s?this.baseHandleRequest(s,a,l,r):this.baseLicenseHandleRequest(n,a,l,r)}static async generateLicenseToken(e,t,r,s,n,a){return v({clientId:e,kid:t,privateKeyPem:r,tokenEndpoint:s,resourceUrl:n,licenseXml:a,debug:_})}static async generateCustomerJWT(e,t,r,s=3600){return S({customerURN:e,kid:t,privateKeyPem:r,expirationSeconds:s})}};u.baseUrl="https://api-connect.sbx.supertab.co",u._instance=null;var k=u;0&&(module.exports={SupertabConnect});
//# sourceMappingURL=index.js.map