"use strict";var f=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var v=Object.prototype.hasOwnProperty;var I=(n,e)=>{for(var a in e)f(n,a,{get:e[a],enumerable:!0})},w=(n,e,a,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of _(e))!v.call(n,r)&&r!==a&&f(n,r,{get:()=>e[r],enumerable:!(s=m(e,r))||s.enumerable});return n};var E=n=>w(f({},"__esModule",{value:!0}),n);var R={};I(R,{SupertabConnect:()=>g});module.exports=E(R);var o=require("jose"),p=new Map,i=!1,g=class{constructor(e){if(!e.apiKey||!e.merchantSystemId)throw new Error("Missing required configuration: apiKey and merchantSystemId are required");this.apiKey=e.apiKey,this.merchantSystemId=e.merchantSystemId,this.baseUrl="https://api-connect.sbx.supertab.co"}async getJwksForIssuer(e){if(!p.has(e)){let a=`${this.baseUrl}/.well-known/jwks.json/${encodeURIComponent(e)}`;try{let s=await fetch(a);if(!s.ok)throw new Error(`Failed to fetch JWKS: ${s.status}`);let r=await s.json();p.set(e,r)}catch(s){throw i&&console.error("Error fetching JWKS:",s),s}}return p.get(e)}async verifyToken(e){if(!e)return{valid:!1,reason:"missing_token"};let a;try{a=(0,o.decodeProtectedHeader)(e)}catch(t){return i&&console.error("Invalid JWT header:",t),{valid:!1,reason:"invalid_header"}}if(a.alg!=="RS256")return{valid:!1,reason:"invalid_algorithm"};let s;try{s=(0,o.decodeJwt)(e)}catch(t){return i&&console.error("Invalid JWT payload:",t),{valid:!1,reason:"invalid_payload"}}let r=s.iss;if(!r||!r.startsWith("urn:stc:customer:"))return{valid:!1,reason:"invalid_issuer"};try{let t=await this.getJwksForIssuer(r);return{valid:!0,payload:(await(0,o.jwtVerify)(e,async d=>{let l=t.keys.find(u=>u.kid===d.kid);if(!l)throw new Error(`No matching key found: ${d.kid}`);return l},{issuer:r,algorithms:["RS256"],clockTolerance:"1m"})).payload}}catch(t){return i&&console.error("JWT verification failed:",t),t.message?.includes("exp")?{valid:!1,reason:"token_expired"}:{valid:!1,reason:"signature_verification_failed"}}}async recordEvent(e,a,s={}){let r={event_name:e,customer_system_token:a,merchant_system_identifier:this.merchantSystemId,properties:s};try{let t=await fetch(`${this.baseUrl}/events`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(r)});t.ok||i&&console.error(`Failed to record event: ${t.status}`)}catch(t){i&&console.error("Error recording event:",t)}}async baseHandleRequest(e,a,s,r){let t=await this.verifyToken(e);async function y(c,d,l){let u={page_url:a,user_agent:s,verification_status:t.valid?"valid":"invalid",verification_reason:t.reason||"success"};if(l){let h=c.recordEvent(d,e,u);return l.waitUntil(h),h}else return await c.recordEvent(d,e,u)}if(!t.valid){await y(this,t.reason||"token_verification_failed",r);let c="\u274C Content access denied"+(t.reason?`: ${t.reason}`:"");return new Response(c,{status:403,headers:new Headers({"Content-Type":"application/json"})})}return await y(this,"page_viewed",r),new Response("\u2705 Content Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})})}extractDataFromRequest(e){let a=e.headers.get("Authorization")||"",s=a.startsWith("Bearer ")?a.slice(7):"",r=e.url,t=e.headers.get("User-Agent")||"unknown";return{token:s,url:r,user_agent:t}}async cloudflareHandleRequest(e,a=null){let{token:s,url:r,user_agent:t}=this.extractDataFromRequest(e);return this.baseHandleRequest(s,r,t,a)}async fastlyHandleRequest(e,a=null){let{token:s,url:r,user_agent:t}=this.extractDataFromRequest(e);return this.baseHandleRequest(s,r,t,a)}};0&&(module.exports={SupertabConnect});
//# sourceMappingURL=index.js.map