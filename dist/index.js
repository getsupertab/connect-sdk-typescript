"use strict";var f=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var _=Object.prototype.hasOwnProperty;var w=(i,e)=>{for(var t in e)f(i,t,{get:e[t],enumerable:!0})},E=(i,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of v(e))!_.call(i,s)&&s!==t&&f(i,s,{get:()=>e[s],enumerable:!(n=I(e,s))||n.enumerable});return i};var R=i=>E(f({},"__esModule",{value:!0}),i);var S={};w(S,{SupertabConnect:()=>m});module.exports=R(S);var d=require("jose"),h=new Map,c=!1,a=class a{constructor(e,t=!1){this.id=Math.random();if(!t&&a._instance){if(!(e.apiKey===a._instance.apiKey&&e.merchantSystemId===a._instance.merchantSystemId))throw new Error("Cannot create a new instance with different configuration. Use resetInstance to clear the existing instance.");return a._instance}if(t&&a._instance&&a.resetInstance(),!e.apiKey||!e.merchantSystemId)throw new Error("Missing required configuration: apiKey and merchantSystemId are required");this.apiKey=e.apiKey,this.merchantSystemId=e.merchantSystemId,this.baseUrl="https://api-connect.sbx.supertab.co",a._instance=this}static resetInstance(){a._instance=null}async getJwksForIssuer(e){if(!h.has(e)){let t=`${this.baseUrl}/.well-known/jwks.json/${encodeURIComponent(e)}`;try{let n=await fetch(t);if(!n.ok)throw new Error(`Failed to fetch JWKS: ${n.status}`);let s=await n.json();h.set(e,s)}catch(n){throw c&&console.error("Error fetching JWKS:",n),n}}return h.get(e)}async verifyToken(e){if(!e)return{valid:!1,reason:"missing_token"};let t;try{t=(0,d.decodeProtectedHeader)(e)}catch(r){return c&&console.error("Invalid JWT header:",r),{valid:!1,reason:"invalid_header"}}if(t.alg!=="RS256")return{valid:!1,reason:"invalid_algorithm"};let n;try{n=(0,d.decodeJwt)(e)}catch(r){return c&&console.error("Invalid JWT payload:",r),{valid:!1,reason:"invalid_payload"}}let s=n.iss;if(!s||!s.startsWith("urn:stc:customer:"))return{valid:!1,reason:"invalid_issuer"};try{let r=await this.getJwksForIssuer(s);return{valid:!0,payload:(await(0,d.jwtVerify)(e,async u=>{let y=r.keys.find(p=>p.kid===u.kid);if(!y)throw new Error(`No matching key found: ${u.kid}`);return y},{issuer:s,algorithms:["RS256"],clockTolerance:"1m"})).payload}}catch(r){return c&&console.error("JWT verification failed:",r),r.message?.includes("exp")?{valid:!1,reason:"token_expired"}:{valid:!1,reason:"signature_verification_failed"}}}async recordEvent(e,t,n={}){let s={event_name:e,customer_system_token:t,merchant_system_identifier:this.merchantSystemId?this.merchantSystemId:"",properties:n};try{let r=await fetch(`${this.baseUrl}/events`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(s)});r.ok||c&&console.error(`Failed to record event: ${r.status}`)}catch(r){c&&console.error("Error recording event:",r)}}async baseHandleRequest(e,t,n,s){let r=await this.verifyToken(e);async function o(l,u,y){let p={page_url:t,user_agent:n,verification_status:r.valid?"valid":"invalid",verification_reason:r.reason||"success"};if(y){let g=l.recordEvent(u,e,p);return y.waitUntil(g),g}else return await l.recordEvent(u,e,p)}if(!r.valid){await o(this,r.reason||"token_verification_failed",s);let l="\u274C Content access denied"+(r.reason?`: ${r.reason}`:"");return new Response(l,{status:403,headers:new Headers({"Content-Type":"application/json"})})}return await o(this,"page_viewed",s),new Response("\u2705 Content Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})})}extractDataFromRequest(e){let t=e.headers.get("Authorization")||"",n=t.startsWith("Bearer ")?t.slice(7):"",s=e.url,r=e.headers.get("User-Agent")||"unknown";return{token:n,url:s,user_agent:r}}static async cloudflareHandleRequests(e,t,n){let{MERCHANT_SYSTEM_ID:s,MERCHANT_API_KEY:r}=t;return new a({apiKey:r,merchantSystemId:s}).handleRequest(e,void 0,n)}static async fastlyHandleRequests(e,t,n){return new a({apiKey:n,merchantSystemId:t}).handleRequest(e,void 0,null)}async handleRequest(e,t,n){let{token:s,url:r,user_agent:o}=this.extractDataFromRequest(e);return t&&!t(e,n)?new Response("\u2705 Non-Bot Content Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})}):this.baseHandleRequest(s,r,o,n)}};a._instance=null;var m=a;0&&(module.exports={SupertabConnect});
//# sourceMappingURL=index.js.map