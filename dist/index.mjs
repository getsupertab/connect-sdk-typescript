import{jwtVerify as H,decodeProtectedHeader as q,decodeJwt as V}from"jose";import{importPKCS8 as _,SignJWT as E}from"jose";async function P(o,e){let r=["RS256","ES256"];for(let s of r)try{return{key:await _(o,s),alg:s}}catch(n){e&&console.debug(`Private key did not import using ${s}, retrying...`,n)}throw new Error("Unsupported private key format. Expected RSA or P-256 EC private key.")}async function I({clientId:o,privateKeyPem:e,tokenEndpoint:r,resourceUrl:s,licenseXml:n,debug:t}){let{key:i,alg:l}=await P(e,t),c=Math.floor(Date.now()/1e3),g=await new E({}).setProtectedHeader({alg:l}).setIssuer(o).setSubject(o).setIssuedAt(c).setExpirationTime(c+300).setAudience(r).sign(i),a=new URLSearchParams({grant_type:"rsl",client_assertion_type:"urn:ietf:params:oauth:client-assertion-type:jwt-bearer",client_assertion:g,license:n,resource:s}),d={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:a.toString()};try{let p=await fetch(r,d);if(!p.ok){let f=await p.text().catch(()=>""),h=`Failed to obtain license token: ${p.status} ${p.statusText}${f?` - ${f}`:""}`;throw new Error(h)}let y;try{y=await p.json()}catch(f){throw t&&console.error("Failed to parse license token response as JSON:",f),new Error("Failed to parse license token response as JSON")}if(!y?.access_token)throw new Error("License token response missing access_token");return y.access_token}catch(p){throw t&&console.error("Error generating license token:",p),p}}async function A({customerURN:o,kid:e,privateKeyPem:r,expirationSeconds:s=3600}){let n="RS256",t=await _(r,n),i=Math.floor(Date.now()/1e3);return new E({}).setProtectedHeader({alg:n,kid:e}).setIssuer(o).setIssuedAt(i).setExpirationTime(i+s).sign(t)}import{decodeProtectedHeader as N,decodeJwt as C,jwtVerify as D}from"jose";var w=new Map,L="sbx-backend";function U(){let o={method:"GET"};return globalThis?.fastly&&(o={...o,backend:L}),o}async function k({cacheKey:o,url:e,debug:r,failureMessage:s,logLabel:n}){if(!w.has(o))try{let t=await fetch(e,U());if(!t.ok)throw new Error(`${s}: ${t.status}`);let i=await t.json();w.set(o,i)}catch(t){throw r&&console.error(n,t),t}return w.get(o)}async function v(o,e,r){let s=`${o}/.well-known/jwks.json/${encodeURIComponent(e)}`;return k({cacheKey:e,url:s,debug:r,failureMessage:"Failed to fetch JWKS",logLabel:"Error fetching JWKS:"})}async function S(o,e){let r=`${o}/.well-known/.well-known/jwks.json`;return k({cacheKey:"platform_jwks",url:r,debug:e,failureMessage:"Failed to fetch platform JWKS",logLabel:"Error fetching platform JWKS:"})}var R=o=>o.replace(/\/+$/,"");async function J({licenseToken:o,requestUrl:e,supertabBaseUrl:r,debug:s}){if(!o)return{valid:!1,reason:"missing_license_token"};let n;try{n=N(o)}catch(a){return s&&console.error("Invalid license JWT header:",a),{valid:!1,reason:"invalid_license_header"}}if(n.alg!=="ES256")return s&&console.error("Unsupported license JWT alg:",n.alg),{valid:!1,reason:"invalid_license_algorithm"};let t;try{t=C(o)}catch(a){return s&&console.error("Invalid license JWT payload:",a),{valid:!1,reason:"invalid_license_payload"}}let i=t.iss;if(!i||!i.startsWith(r))return s&&console.error("Invalid license JWT issuer:",i),{valid:!1,reason:"invalid_license_issuer"};let l=Array.isArray(t.aud)?t.aud.filter(a=>typeof a=="string"):typeof t.aud=="string"?[t.aud]:[],c=R(e);if(!l.some(a=>{let d=R(a);return d?c.startsWith(d):!1}))return s&&console.error("License JWT audience does not match request URL:",t.aud),{valid:!1,reason:"invalid_license_audience"};try{let a=await S(r,s);return{valid:!0,payload:(await D(o,async y=>{let f=a.keys.find(h=>h.kid===y.kid);if(!f)throw new Error(`No matching platform key found: ${y.kid}`);return f},{issuer:i,algorithms:[n.alg],clockTolerance:"1m"})).payload}}catch(a){return s&&console.error("License JWT verification failed:",a),a instanceof Error&&a.message?.includes("exp")?{valid:!1,reason:"license_token_expired"}:{valid:!1,reason:"license_signature_verification_failed"}}}function x({supertabBaseUrl:o,merchantSystemUrn:e}){return`${o}/merchants/systems/${e}/license.xml`}async function T({licenseToken:o,url:e,userAgent:r,ctx:s,supertabBaseUrl:n,merchantSystemUrn:t,debug:i,recordEvent:l}){let c=await J({licenseToken:o,requestUrl:e,supertabBaseUrl:n,debug:i});async function g(a){let d={page_url:e,user_agent:r,verification_status:c.valid?"valid":"invalid",verification_reason:c.reason||"success"},p=l(a,void 0,o,d);return s?.waitUntil&&s.waitUntil(p),p}if(!c.valid){await g(c.reason||"license_token_verification_failed");let a="invalid_request",d="Access to this resource requires a license";switch(c.reason){case"missing_license_token":a="invalid_request",d="Access to this resource requires a license";break;case"license_token_expired":a="invalid_token",d="The license token has expired";break;case"license_signature_verification_failed":case"invalid_license_header":case"invalid_license_payload":a="invalid_token",d="The license token is invalid";break;case"invalid_license_issuer":case"invalid_license_audience":a="insufficient_scope",d="The license token is not valid for this resource";break;default:a="invalid_request",d="Access to this resource requires a license"}let p=x({supertabBaseUrl:n,merchantSystemUrn:t}),y=`${n}/docs/errors#${a}`,f=new Headers({"Content-Type":"text/plain; charset=UTF-8","WWW-Authenticate":`License error="${a}", error_description="${d}", error_uri="${y}"`,Link:`${p}; rel="license"; type="application/rsl+xml"`}),h=`Access to this resource requires a valid license token. Error: ${a} - ${d}`;return new Response(h,{status:401,headers:f})}return await g("license_used"),new Response("\u2705 License Token Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})})}var m=!0,u=class u{constructor(e,r=!1){if(!r&&u._instance){if(!(e.apiKey===u._instance.apiKey&&e.merchantSystemUrn===u._instance.merchantSystemUrn))throw new Error("Cannot create a new instance with different configuration. Use resetInstance to clear the existing instance.");return u._instance}if(r&&u._instance&&u.resetInstance(),!e.apiKey||!e.merchantSystemUrn)throw new Error("Missing required configuration: apiKey and merchantSystemUrn are required");this.apiKey=e.apiKey,this.merchantSystemUrn=e.merchantSystemUrn,u._instance=this}static resetInstance(){u._instance=null}static setBaseUrl(e){u.baseUrl=e}async verifyToken(e){if(!e)return{valid:!1,reason:"missing_token"};let r;try{r=q(e)}catch(t){return m&&console.error("Invalid JWT header:",t),{valid:!1,reason:"invalid_header"}}if(r.alg!=="RS256")return{valid:!1,reason:"invalid_algorithm"};let s;try{s=V(e)}catch(t){return m&&console.error("Invalid JWT payload:",t),{valid:!1,reason:"invalid_payload"}}let n=s.iss;if(!n||!n.startsWith("urn:stc:customer:"))return{valid:!1,reason:"invalid_issuer"};try{let t=await v(u.baseUrl,n,m);return{valid:!0,payload:(await H(e,async c=>{let g=t.keys.find(a=>a.kid===c.kid);if(!g)throw new Error(`No matching key found: ${c.kid}`);return g},{issuer:n,algorithms:["RS256"],clockTolerance:"1m"})).payload}}catch(t){return m&&console.error("JWT verification failed:",t),t.message?.includes("exp")?{valid:!1,reason:"token_expired"}:{valid:!1,reason:"signature_verification_failed"}}}async recordEvent(e,r,s,n={}){let t={event_name:e,customer_system_token:r,license_token:s,merchant_system_urn:this.merchantSystemUrn?this.merchantSystemUrn:"",properties:n};try{let i={method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(t)};globalThis?.fastly&&(i={...i,backend:"sbx-backend"});let l=await fetch(`${u.baseUrl}/events`,i);l.ok||console.log(`Failed to record event: ${l.status}`)}catch(i){console.log("Error recording event:",i)}}async baseHandleRequest(e,r,s,n){let t=await this.verifyToken(e);async function i(l,c,g){let a={page_url:r,user_agent:s,verification_status:t.valid?"valid":"invalid",verification_reason:t.reason||"success"};if(g){let d=l.recordEvent(c,e,void 0,a);return g.waitUntil(d),d}else return await l.recordEvent(c,e,void 0,a)}if(!t.valid){await i(this,t.reason||"token_verification_failed",n);let l="Payment required: you need to present a valid Supertab Connect token to access this content. Check out the provided url for details",c="\u274C Content access denied"+(t.reason?`: ${t.reason}`:""),a={url:`${u.baseUrl}/merchants/systems/${this.merchantSystemUrn}/content-access.json`,message:l,details:c};return new Response(JSON.stringify(a),{status:402,headers:new Headers({"Content-Type":"application/json"})})}return await i(this,"page_viewed",n),new Response("\u2705 Content Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})})}async baseLicenseHandleRequest(e,r,s,n){return T({licenseToken:e,url:r,userAgent:s,ctx:n,supertabBaseUrl:u.baseUrl,merchantSystemUrn:this.merchantSystemUrn,debug:m,recordEvent:(t,i,l,c)=>this.recordEvent(t,i,l,c)})}extractDataFromRequest(e){let r=e.headers.get("Authorization")||"",s=r.startsWith("Bearer ")?r.slice(7):"",n=r.startsWith("License ")?r.slice(8):"",t=e.url,i=e.headers.get("User-Agent")||"unknown";return{token:s,licenseToken:n,url:t,user_agent:i}}static checkIfBotRequest(e){let r=e.headers.get("User-Agent")||"",s=e.headers.get("accept")||"",n=e.headers.get("sec-ch-ua"),t=e.headers.get("accept-language"),i=e.cf?.botManagement?.score,l=["chatgpt-user","perplexitybot","gptbot","anthropic-ai","ccbot","claude-web","claudebot","cohere-ai","youbot","diffbot","oai-searchbot","meta-externalagent","timpibot","amazonbot","bytespider","perplexity-user","googlebot","bot","curl","wget"],c=r.toLowerCase(),g=l.some(f=>c.includes(f)),a=r.toLowerCase().includes("headless")||r.toLowerCase().includes("puppeteer")||!n,d=!r.toLowerCase().includes("headless")||!r.toLowerCase().includes("puppeteer")||!n,p=!s||!t,y=typeof i=="number"&&i<30;return console.log("Bot Detection Details:",{botUaMatch:g,headlessIndicators:a,missingHeaders:p,lowBotScore:y,botScore:i}),(c.includes("safari")||c.includes("mozilla"))&&a&&d?!1:g||a||p||y}static async cloudflareHandleRequests(e,r,s){let{MERCHANT_SYSTEM_URN:n,MERCHANT_API_KEY:t}=r;return new u({apiKey:t,merchantSystemUrn:n}).handleRequest(e,u.checkIfBotRequest,s)}static async fastlyHandleRequests(e,r,s){return new u({apiKey:s,merchantSystemUrn:r}).handleRequest(e,u.checkIfBotRequest,null)}async handleRequest(e,r,s){let{token:n,licenseToken:t,url:i,user_agent:l}=this.extractDataFromRequest(e);return r&&!r(e,s)?new Response("\u2705 Non-Bot Content Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})}):n?this.baseHandleRequest(n,i,l,s):this.baseLicenseHandleRequest(t,i,l,s)}static async generateLicenseToken(e,r,s,n,t){return I({clientId:e,privateKeyPem:r,tokenEndpoint:s,resourceUrl:n,licenseXml:t,debug:m})}static async generateCustomerJWT(e,r,s,n=3600){return A({customerURN:e,kid:r,privateKeyPem:s,expirationSeconds:n})}};u.baseUrl="https://api-connect.sbx.supertab.co",u._instance=null;var b=u;export{b as SupertabConnect};
//# sourceMappingURL=index.mjs.map