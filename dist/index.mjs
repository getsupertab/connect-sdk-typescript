import{jwtVerify as l,decodeProtectedHeader as y,decodeJwt as f}from"jose";var i=new Map,c=class{constructor(e){this.apiKey=e.apiKey,this.merchantSystemId=e.merchantSystemId,this.baseUrl=e.baseUrl||"https://api-connect.sbx.supertab.co",this.debug=e.debug||!1}async getJwksForIssuer(e){if(!i.has(e)){let s=`${this.baseUrl}/.well-known/jwks.json/${encodeURIComponent(e)}`;try{let t=await fetch(s);if(!t.ok)throw new Error(`Failed to fetch JWKS: ${t.status}`);let a=await t.json();i.set(e,a)}catch(t){throw this.debug&&console.error("Error fetching JWKS:",t),t}}return i.get(e)}async verifyToken(e){if(!e)return{valid:!1,reason:"missing_token"};let s;try{s=y(e)}catch(r){return this.debug&&console.error("Invalid JWT header:",r),{valid:!1,reason:"invalid_header"}}if(s.alg!=="RS256")return{valid:!1,reason:"invalid_algorithm"};let t;try{t=f(e)}catch(r){return this.debug&&console.error("Invalid JWT payload:",r),{valid:!1,reason:"invalid_payload"}}let a=t.iss;if(!a||!a.startsWith("urn:stc:customer:"))return{valid:!1,reason:"invalid_issuer"};try{let r=await this.getJwksForIssuer(a);return{valid:!0,payload:(await l(e,async n=>{let o=r.keys.find(d=>d.kid===n.kid);if(!o)throw new Error(`No matching key found: ${n.kid}`);return o},{issuer:a,algorithms:["RS256"],clockTolerance:"1m"})).payload}}catch(r){return this.debug&&console.error("JWT verification failed:",r),r.message?.includes("exp")?{valid:!1,reason:"token_expired"}:{valid:!1,reason:"signature_verification_failed"}}}async recordEvent(e,s,t={}){let a={event_name:e,customer_system_token:s,merchant_system_identifier:this.merchantSystemId,properties:t};try{let r=await fetch(`${this.baseUrl}/events`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(a)});r.ok||this.debug&&console.error(`Failed to record event: ${r.status}`)}catch(r){this.debug&&console.error("Error recording event:",r)}}};export{c as SupertabConnect};
//# sourceMappingURL=index.mjs.map
