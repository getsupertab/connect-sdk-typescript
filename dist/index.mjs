import{jwtVerify as h,decodeProtectedHeader as m,decodeJwt as g}from"jose";var y=new Map,o=!1,a=class a{constructor(e,n=!1){this.id=Math.random();if(!n&&a._instance){if(!(e.apiKey===a._instance.apiKey&&e.merchantSystemId===a._instance.merchantSystemId))throw new Error("Cannot create a new instance with different configuration. Use resetInstance to clear the existing instance.");return a._instance}if(n&&a._instance&&a.resetInstance(),!e.apiKey||!e.merchantSystemId)throw new Error("Missing required configuration: apiKey and merchantSystemId are required");this.apiKey=e.apiKey,this.merchantSystemId=e.merchantSystemId,this.baseUrl="https://api-connect.sbx.supertab.co",a._instance=this}static resetInstance(){a._instance=null}async getJwksForIssuer(e){if(!y.has(e)){let n=`${this.baseUrl}/.well-known/jwks.json/${encodeURIComponent(e)}`;try{let r=await fetch(n);if(!r.ok)throw new Error(`Failed to fetch JWKS: ${r.status}`);let s=await r.json();y.set(e,s)}catch(r){throw o&&console.error("Error fetching JWKS:",r),r}}return y.get(e)}async verifyToken(e){if(!e)return{valid:!1,reason:"missing_token"};let n;try{n=m(e)}catch(t){return o&&console.error("Invalid JWT header:",t),{valid:!1,reason:"invalid_header"}}if(n.alg!=="RS256")return{valid:!1,reason:"invalid_algorithm"};let r;try{r=g(e)}catch(t){return o&&console.error("Invalid JWT payload:",t),{valid:!1,reason:"invalid_payload"}}let s=r.iss;if(!s||!s.startsWith("urn:stc:customer:"))return{valid:!1,reason:"invalid_issuer"};try{let t=await this.getJwksForIssuer(s);return{valid:!0,payload:(await h(e,async d=>{let l=t.keys.find(u=>u.kid===d.kid);if(!l)throw new Error(`No matching key found: ${d.kid}`);return l},{issuer:s,algorithms:["RS256"],clockTolerance:"1m"})).payload}}catch(t){return o&&console.error("JWT verification failed:",t),t.message?.includes("exp")?{valid:!1,reason:"token_expired"}:{valid:!1,reason:"signature_verification_failed"}}}async recordEvent(e,n,r={}){let s={event_name:e,customer_system_token:n,merchant_system_identifier:this.merchantSystemId?this.merchantSystemId:"",properties:r};try{let t=await fetch(`${this.baseUrl}/events`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(s)});t.ok||o&&console.error(`Failed to record event: ${t.status}`)}catch(t){o&&console.error("Error recording event:",t)}}async baseHandleRequest(e,n,r,s){let t=await this.verifyToken(e);async function i(c,d,l){let u={page_url:n,user_agent:r,verification_status:t.valid?"valid":"invalid",verification_reason:t.reason||"success"};if(l){let p=c.recordEvent(d,e,u);return l.waitUntil(p),p}else return await c.recordEvent(d,e,u)}if(!t.valid){await i(this,t.reason||"token_verification_failed",s);let c="\u274C Content access denied"+(t.reason?`: ${t.reason}`:"");return new Response(c,{status:403,headers:new Headers({"Content-Type":"application/json"})})}return await i(this,"page_viewed",s),new Response("\u2705 Content Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})})}extractDataFromRequest(e){let n=e.headers.get("Authorization")||"",r=n.startsWith("Bearer ")?n.slice(7):"",s=e.url,t=e.headers.get("User-Agent")||"unknown";return{token:r,url:s,user_agent:t}}static async cloudflareHandleRequests(e,n,r){let{MERCHANT_SYSTEM_ID:s,MERCHANT_API_KEY:t}=n;return new a({apiKey:t,merchantSystemId:s}).handleRequest(e,void 0,r)}static async fastlyHandleRequests(e,n,r){return new a({apiKey:r,merchantSystemId:n}).handleRequest(e,void 0,null)}async handleRequest(e,n,r){let{token:s,url:t,user_agent:i}=this.extractDataFromRequest(e);return n&&!n(e,r)?new Response("\u2705 Non-Bot Content Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})}):this.baseHandleRequest(s,t,i,r)}};a._instance=null;var f=a;export{f as SupertabConnect};
//# sourceMappingURL=index.mjs.map