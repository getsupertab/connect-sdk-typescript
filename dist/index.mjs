import{jwtVerify as p,decodeProtectedHeader as g,decodeJwt as h}from"jose";var u=new Map,n=!1,f=class{constructor(e){if(!e.apiKey||!e.merchantSystemId)throw new Error("Missing required configuration: apiKey and merchantSystemId are required");this.apiKey=e.apiKey,this.merchantSystemId=e.merchantSystemId,this.baseUrl="https://api-connect.sbx.supertab.co"}async getJwksForIssuer(e){if(!u.has(e)){let a=`${this.baseUrl}/.well-known/jwks.json/${encodeURIComponent(e)}`;try{let r=await fetch(a);if(!r.ok)throw new Error(`Failed to fetch JWKS: ${r.status}`);let s=await r.json();u.set(e,s)}catch(r){throw n&&console.error("Error fetching JWKS:",r),r}}return u.get(e)}async verifyToken(e){if(!e)return{valid:!1,reason:"missing_token"};let a;try{a=g(e)}catch(t){return n&&console.error("Invalid JWT header:",t),{valid:!1,reason:"invalid_header"}}if(a.alg!=="RS256")return{valid:!1,reason:"invalid_algorithm"};let r;try{r=h(e)}catch(t){return n&&console.error("Invalid JWT payload:",t),{valid:!1,reason:"invalid_payload"}}let s=r.iss;if(!s||!s.startsWith("urn:stc:customer:"))return{valid:!1,reason:"invalid_issuer"};try{let t=await this.getJwksForIssuer(s);return{valid:!0,payload:(await p(e,async o=>{let c=t.keys.find(d=>d.kid===o.kid);if(!c)throw new Error(`No matching key found: ${o.kid}`);return c},{issuer:s,algorithms:["RS256"],clockTolerance:"1m"})).payload}}catch(t){return n&&console.error("JWT verification failed:",t),t.message?.includes("exp")?{valid:!1,reason:"token_expired"}:{valid:!1,reason:"signature_verification_failed"}}}async recordEvent(e,a,r={}){let s={event_name:e,customer_system_token:a,merchant_system_identifier:this.merchantSystemId,properties:r};try{let t=await fetch(`${this.baseUrl}/events`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(s)});t.ok||n&&console.error(`Failed to record event: ${t.status}`)}catch(t){n&&console.error("Error recording event:",t)}}async baseHandleRequest(e,a,r,s){let t=await this.verifyToken(e);async function l(i,o,c){let d={page_url:a,user_agent:r,verification_status:t.valid?"valid":"invalid",verification_reason:t.reason||"success"};if(c){let y=i.recordEvent(o,e,d);return c.waitUntil(y),y}else return await i.recordEvent(o,e,d)}if(!t.valid){await l(this,t.reason||"token_verification_failed",s);let i="\u274C Content access denied"+(t.reason?`: ${t.reason}`:"");return new Response(i,{status:403,headers:new Headers({"Content-Type":"application/json"})})}return await l(this,"page_viewed",s),new Response("\u2705 Content Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})})}extractDataFromRequest(e){let a=e.headers.get("Authorization")||"",r=a.startsWith("Bearer ")?a.slice(7):"",s=e.url,t=e.headers.get("User-Agent")||"unknown";return{token:r,url:s,user_agent:t}}async cloudflareHandleRequest(e,a=null){let{token:r,url:s,user_agent:t}=this.extractDataFromRequest(e);return this.baseHandleRequest(r,s,t,a)}async fastlyHandleRequest(e,a=null){let{token:r,url:s,user_agent:t}=this.extractDataFromRequest(e);return this.baseHandleRequest(r,s,t,a)}};export{f as SupertabConnect};
//# sourceMappingURL=index.mjs.map