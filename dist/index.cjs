"use strict";var ee=Object.create;var x=Object.defineProperty;var te=Object.getOwnPropertyDescriptor;var re=Object.getOwnPropertyNames;var ne=Object.getPrototypeOf,se=Object.prototype.hasOwnProperty;var oe=(t,e)=>{for(var n in e)x(t,n,{get:e[n],enumerable:!0})},N=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of re(e))!se.call(t,s)&&s!==n&&x(t,s,{get:()=>e[s],enumerable:!(r=te(e,s))||r.enumerable});return t};var w=(t,e,n)=>(n=t!=null?ee(ne(t)):{},N(e||!t||!t.__esModule?x(n,"default",{value:t,enumerable:!0}):n,t)),ie=t=>N(x({},"__esModule",{value:!0}),t);var we={};oe(we,{EnforcementMode:()=>v,HandlerAction:()=>L,LicenseTokenInvalidReason:()=>I,SupertabConnect:()=>P,defaultBotDetector:()=>Y});module.exports=ie(we);var v=(r=>(r.DISABLED="disabled",r.SOFT="soft",r.STRICT="strict",r))(v||{}),I=(l=>(l.MISSING_TOKEN="missing_license_token",l.INVALID_HEADER="invalid_license_header",l.INVALID_ALG="invalid_license_algorithm",l.INVALID_PAYLOAD="invalid_license_payload",l.INVALID_ISSUER="invalid_license_issuer",l.SIGNATURE_VERIFICATION_FAILED="license_signature_verification_failed",l.EXPIRED="license_token_expired",l.INVALID_AUDIENCE="invalid_license_audience",l.SERVER_ERROR="server_error",l))(I||{}),b="stc-backend",L=(n=>(n.ALLOW="allow",n.BLOCK="block",n))(L||{});function k(t){let e=null;return()=>(e||(e=t()),e)}var H=k(()=>import("jose/jwt/verify")),S=k(()=>import("jose/jwt/decode")),K=k(()=>import("jose/decode/protected_header")),ae=k(()=>import("jose/key/import")),ce=k(()=>import("jose/jwt/sign"));var T=new Map;function le(t,e){let n=T.get(t);if(!n)return null;let r=Math.floor(Date.now()/1e3);return n.exp>r+30?(e&&console.debug(`Using cached license token (expires in ${n.exp-r}s)`),n.token):(e&&console.debug("Cached license token expired or expiring soon, refreshing"),T.delete(t),null)}async function ue(t,e,n){try{let r=await fetch(t,e);if(!r.ok){let o=await r.text().catch(()=>""),c=`Failed to obtain license token: ${r.status} ${r.statusText}${o?` - ${o}`:""}`;throw new Error(c)}let s;try{s=await r.json()}catch(o){throw n&&console.error("Failed to parse license token response as JSON:",o),new Error("Failed to parse license token response as JSON")}if(!s?.access_token)throw new Error("License token response missing access_token");return s.access_token}catch(r){throw n&&console.error("Error generating license token:",r),r}}async function de(t,e){let r=`${new URL(t).origin}/license.xml`,s=await fetch(r);if(!s.ok)throw e&&console.error(`Failed to fetch license.xml from ${r}: ${s.status}`),new Error(`Failed to fetch license.xml from ${r}: ${s.status}`);let o=await s.text();return e&&console.debug("Fetched license.xml from",r),o}function fe(t,e){let n=[],r=/<content\s([^>]*)>([\s\S]*?)<\/content>/gi,s=/url\s*=\s*"([^"]*)"/i,o=/server\s*=\s*"([^"]*)"/i,c=/<license[^>]*>[\s\S]*?<\/license>/i,i=0,a;for(;(a=r.exec(t))!==null;){i++;let l=a[1],d=a[2],p=l.match(s),f=l.match(o),g=d.match(c);if(p&&f&&g)n.push({urlPattern:p[1],server:f[1],licenseXml:g[0]});else if(e){let R=[!p&&"url",!f&&"server",!g&&"<license>"].filter(Boolean).join(", ");console.debug(`Skipping <content> element #${i}: missing ${R}`)}}return e&&console.debug(`Found ${i} <content> element(s), ${n.length} valid`),n}function pe(t,e,n){let r=new URL(e),s=r.host,o=r.pathname;n&&console.debug(`Matching resource URL: ${e} (host=${s}, path=${o})`);let c=null,i=-1;for(let a of t){let l;try{l=new URL(a.urlPattern)}catch{n&&console.debug(`Skipping block with invalid URL pattern: ${a.urlPattern}`);continue}if(l.host!==s){n&&console.debug(`Skipping block: host mismatch (pattern=${l.host}, resource=${s})`);continue}let d=l.pathname;if(d===o)return n&&console.debug(`Exact match found: ${a.urlPattern}`),a;if(d.endsWith("/*")){let p=d.slice(0,-1);if(o.startsWith(p)){let f=p.length;f>i&&(i=f,c=a)}}}return n&&console.debug(c?`Wildcard match found: ${c.urlPattern} (specificity=${i})`:`No matching content block found for ${e}`),c}async function $({clientId:t,clientSecret:e,resourceUrl:n,debug:r}){let s=`${t}:${n}`,o=le(s,r);if(o)return o;let c=await de(n,r);r&&console.debug(`Fetched license.xml (${c.length} chars)`);let i=fe(c,r);if(i.length===0)throw r&&console.error("No valid <content> elements with <license> found in license.xml"),new Error("No valid <content> elements with <license> found in license.xml");let a=pe(i,n,r);if(!a){if(r){let g=i.map(R=>R.urlPattern).join(", ");console.error(`No <content> element matches resource URL: ${n}. Available patterns: ${g}`)}throw new Error(`No <content> element in license.xml matches resource URL: ${n}`)}r&&(console.debug("Matched content block for resource URL:",n),console.debug("Using license XML:",a.licenseXml));let l=a.server+"/token";r&&console.debug(`Requesting license token from ${l}`);let d=new URLSearchParams({grant_type:"client_credentials",license:a.licenseXml,resource:a.urlPattern}),p={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json",Authorization:"Basic "+btoa(`${t}:${e}`)},body:d.toString()},f=await ue(l,p,r);try{let{decodeJwt:g}=await S(),R=g(f);R.exp&&T.set(s,{token:f,exp:R.exp})}catch{r&&console.debug("Failed to decode token for caching, skipping cache")}return f}var C=new Map,he=48*60*60*1e3,E=class extends Error{constructor(e){super(`No matching platform key found: ${e}`),this.name="JwksKeyNotFoundError"}};function ge(){let t={method:"GET"};return globalThis.fastly&&(t={...t,backend:b}),t}async function me({cacheKey:t,url:e,debug:n,failureMessage:r,logLabel:s}){let o=C.get(t);if(o&&Date.now()-o.cachedAt<he)return o.data;try{let c=await fetch(e,ge());if(!c.ok)throw new Error(`${r}: ${c.status}`);let i=await c.json();return C.set(t,{data:i,cachedAt:Date.now()}),i}catch(c){throw n&&console.error(s,c),c}}async function B(t,e){let n=`${t}/.well-known/jwks.json/platform`;return e&&console.debug(`Fetching platform JWKS from URL: ${n}`),me({cacheKey:"platform_jwks",url:n,debug:e,failureMessage:"Failed to fetch platform JWKS",logLabel:"Error fetching platform JWKS:"})}function V(){C.clear()}async function J({apiKey:t,baseUrl:e,eventName:n,properties:r,licenseId:s,debug:o=!1}){let c={event_name:n,license_id:s,properties:r};try{let i={method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(c)};globalThis.fastly&&(i={...i,backend:b});let a=await fetch(`${e}/events`,i);!a.ok&&o&&console.error(`Failed to record event: ${a.status}`)}catch(i){o&&console.error("Error recording event:",i)}}var A=t=>t.trim().replace(/\/+$/,"");function y(t){switch(t){case"missing_license_token":return"Authorization header missing or malformed";case"invalid_license_algorithm":return"Unsupported token algorithm";case"license_token_expired":return"The license token has expired";case"license_signature_verification_failed":return"The license token signature is invalid";case"invalid_license_header":return"The license token header is malformed";case"invalid_license_payload":return"The license token payload is malformed";case"invalid_license_issuer":return"The license token issuer is not recognized";case"invalid_license_audience":return"The license does not grant access to this resource";case"server_error":return"The server encountered an error validating the license";default:return"License token missing, expired, revoked, or malformed"}}async function U({licenseToken:t,requestUrl:e,supertabBaseUrl:n,debug:r}){let{decodeProtectedHeader:s}=await K(),{decodeJwt:o}=await S(),{jwtVerify:c}=await H();if(!t)return{valid:!1,reason:"missing_license_token",error:y("missing_license_token")};let i;try{i=s(t)}catch(h){return r&&console.error("Invalid license JWT header:",h),{valid:!1,reason:"invalid_license_header",error:y("invalid_license_header")}}if(i.alg!=="ES256")return r&&console.error("Unsupported license JWT alg:",i.alg),{valid:!1,reason:"invalid_license_algorithm",error:y("invalid_license_algorithm")};let a;try{a=o(t)}catch(h){return r&&console.error("Invalid license JWT payload:",h),{valid:!1,reason:"invalid_license_payload",error:y("invalid_license_payload")}}let l=a.license_id,d=a.iss,p=d?A(d):void 0,f=A(n);if(!p||!p.startsWith(f))return r&&console.error("License JWT issuer is missing or malformed:",d),{valid:!1,reason:"invalid_license_issuer",error:y("invalid_license_issuer"),licenseId:l};let g=Array.isArray(a.aud)?a.aud.filter(h=>typeof h=="string"):typeof a.aud=="string"?[a.aud]:[],R=A(e);if(!g.some(h=>{let m=A(h);return m?R.startsWith(m):!1}))return r&&console.error("License JWT audience does not match request URL:",a.aud),{valid:!1,reason:"invalid_license_audience",error:y("invalid_license_audience"),licenseId:l};let F=async()=>{let h;try{h=await B(n,r)}catch(m){return r&&console.error("Failed to fetch platform JWKS:",m),{valid:!1,reason:"server_error",error:y("server_error"),licenseId:l}}try{let Q=await c(t,async q=>{let O=h.keys.find(Z=>Z.kid===q.kid);if(!O)throw new E(q.kid);return O},{issuer:d,algorithms:[i.alg],clockTolerance:"1m"});return{valid:!0,licenseId:l,payload:Q.payload}}catch(m){if(r&&console.error("License JWT verification failed:",m),m instanceof E)throw m;return m instanceof Error&&m.message?.includes("exp")?{valid:!1,reason:"license_token_expired",error:y("license_token_expired"),licenseId:l}:{valid:!1,reason:"license_signature_verification_failed",error:y("license_signature_verification_failed"),licenseId:l}}};try{return await F()}catch(h){if(h instanceof E)return r&&console.debug("Key not found in cached JWKS, clearing cache and retrying..."),V(),await F();throw h}}function W({requestUrl:t}){try{let e=new URL(t);return`${e.protocol}//${e.host}/license.xml`}catch(e){return console.error("[SupertabConnect] generateLicenseLink failed to parse URL:",e),"/license.xml"}}function M(t){let e=W({requestUrl:t});return{action:"allow",headers:{Link:`<${e}>; rel="license"; type="application/rsl+xml"`,"X-RSL-Status":"token_required","X-RSL-Reason":"missing"}}}function ye(t){switch(t){case"missing_license_token":case"invalid_license_algorithm":return{rslError:"invalid_request",status:401};case"license_token_expired":case"license_signature_verification_failed":case"invalid_license_header":case"invalid_license_payload":case"invalid_license_issuer":return{rslError:"invalid_token",status:401};case"invalid_license_audience":return{rslError:"insufficient_scope",status:403};case"server_error":return{rslError:"server_error",status:503};default:return{rslError:"invalid_token",status:401}}}function Re(t){return t.replace(/[\r\n]/g,"").replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function D({reason:t,error:e,requestUrl:n}){let{rslError:r,status:s}=ye(t),o=Re(e),c=W({requestUrl:n});return{action:"block",status:s,body:`Access to this resource requires a valid license token. Error: ${r} - ${e}`,headers:{"Content-Type":"text/plain; charset=UTF-8","WWW-Authenticate":`License error="${r}", error_description="${o}"`,Link:`<${c}>; rel="license"; type="application/rsl+xml"`}}}function be(){let t={method:"GET"};return globalThis.fastly&&(t={...t,backend:b}),t}async function j(t,e){try{let n=`${t}/merchants/systems/${e}/license.xml`,r=await fetch(n,be());if(!r.ok)return new Response("License not found",{status:404});let s=await r.text();return new Response(s,{status:200,headers:new Headers({"Content-Type":"application/xml"})})}catch(n){return console.error("[SupertabConnect] hostRSLicenseXML failed:",n),new Response("Bad Gateway",{status:502})}}async function _(t){let e=await U({licenseToken:t.token,requestUrl:t.url,supertabBaseUrl:t.supertabBaseUrl,debug:t.debug}),n=J({apiKey:t.apiKey,baseUrl:t.supertabBaseUrl,eventName:e.valid?"license_used":e.reason,properties:{page_url:t.url,user_agent:t.userAgent,verification_status:e.valid?"valid":"invalid",verification_reason:e.valid?"success":e.reason},licenseId:e.licenseId,debug:t.debug});return t.ctx?.waitUntil&&t.ctx.waitUntil(n),e}async function G(t,e,n){let r=await t.handleRequest(e,n);if(r.action==="block")return new Response(r.body,{status:r.status,headers:new Headers(r.headers)});let s=await fetch(e);if(r.headers){let o=new Response(s.body,s);for(let[c,i]of Object.entries(r.headers))o.headers.set(c,i);return o}return s}async function X(t,e,n,r){if(r&&new URL(e.url).pathname==="/license.xml")return await j(r.baseUrl,r.merchantSystemUrn);let s=await t.handleRequest(e);if(s.action==="block")return new Response(s.body,{status:s.status,headers:new Headers(s.headers)});let o=await fetch(e,{backend:n});if(s.headers){let c=new Response(o.body,o);for(let[i,a]of Object.entries(s.headers))c.headers.set(i,a);return c}return o}function Ee(t){switch(t){case 401:return"Unauthorized";case 403:return"Forbidden";case 503:return"Service Unavailable";default:return"Error"}}async function z(t,e){let n=e.Records[0].cf.request,r=`https://${n.headers.host[0].value}${n.uri}${n.querystring?"?"+n.querystring:""}`,s=new Headers;Object.entries(n.headers).forEach(([i,a])=>{a.forEach(({value:l})=>s.append(i,l))});let o=new Request(r,{method:n.method,headers:s}),c=await t.handleRequest(o);if(c.action==="block"){let i={};return Object.entries(c.headers).forEach(([a,l])=>{i[a.toLowerCase()]=[{key:a,value:l}]}),{status:c.status.toString(),statusDescription:Ee(c.status),headers:i,body:c.body}}return n}function Y(t){let e=t.headers.get("User-Agent")||"",n=t.headers.get("accept")||"",r=t.headers.get("sec-ch-ua"),s=t.headers.get("accept-language"),o=t.cf?.botManagement?.score,c=["chatgpt-user","perplexitybot","gptbot","anthropic-ai","ccbot","claude-web","claudebot","cohere-ai","youbot","diffbot","oai-searchbot","meta-externalagent","timpibot","amazonbot","bytespider","perplexity-user","googlebot","bot","curl","wget"],i=e.toLowerCase(),a=c.some(g=>i.includes(g)),l=i.includes("headless")||i.includes("puppeteer")||!r,d=!i.includes("headless")&&!i.includes("puppeteer")&&!r,p=!n||!s,f=typeof o=="number"&&o<30;return(i.includes("safari")||i.includes("mozilla"))&&l&&d?!1:a||l||p||f}var u=class u{constructor(e,n=!1){if(!n&&u._instance){if(e.apiKey!==u._instance.apiKey)throw new Error("Cannot create a new instance with different configuration. Use resetInstance to clear the existing instance.");return u._instance}if(n&&u._instance&&u.resetInstance(),!e.apiKey)throw new Error("Missing required configuration: apiKey is required");this.apiKey=e.apiKey,this.enforcement=e.enforcement??"soft",this.botDetector=e.botDetector,this.debug=e.debug??!1,u._instance=this}static resetInstance(){u._instance=null}static setBaseUrl(e){u.baseUrl=e}static getBaseUrl(){return u.baseUrl}static async verify(e){let n=e.baseUrl??u.baseUrl,r=await U({licenseToken:e.token,requestUrl:e.resourceUrl,supertabBaseUrl:n,debug:e.debug??!1});return r.valid?{valid:!0}:{valid:!1,error:r.error}}async verifyAndRecord(e){let n=await _({token:e.token,url:e.resourceUrl,userAgent:e.userAgent??"unknown",supertabBaseUrl:u.baseUrl,debug:e.debug??this.debug,apiKey:this.apiKey,ctx:e.ctx});return n.valid?{valid:!0}:{valid:!1,error:n.error}}async handleRequest(e,n){let r=e.headers.get("Authorization")||"",s=r.startsWith("License ")?r.slice(8):null,o=e.url,c=e.headers.get("User-Agent")||"unknown";if(s){if(this.enforcement==="disabled")return{action:"allow"};let a=await _({token:s,url:o,userAgent:c,supertabBaseUrl:u.baseUrl,debug:this.debug,apiKey:this.apiKey,ctx:n});return a.valid?{action:"allow"}:D({reason:a.reason,error:a.error,requestUrl:o})}if(!(this.botDetector?.(e,n)??!1))return{action:"allow"};switch(this.enforcement){case"strict":return D({reason:"missing_license_token",error:"Authorization header missing or malformed",requestUrl:o});case"soft":return M(o);default:return{action:"allow"}}}static async obtainLicenseToken(e){return $({clientId:e.clientId,clientSecret:e.clientSecret,resourceUrl:e.resourceUrl,debug:e.debug})}static async cloudflareHandleRequests(e,n,r,s){try{let o=new u({apiKey:n.MERCHANT_API_KEY,botDetector:s?.botDetector,enforcement:s?.enforcement});return await G(o,e,r)}catch(o){return console.error("[SupertabConnect] cloudflareHandleRequests failed:",o),await fetch(e)}}static async fastlyHandleRequests(e,n,r,s){try{let{botDetector:o,enforcement:c}=s??{},i=new u({apiKey:n,botDetector:o,enforcement:c}),a;return s?.enableRSL&&(a={baseUrl:u.baseUrl,merchantSystemUrn:s.merchantSystemUrn}),await X(i,e,r,a)}catch(o){return console.error("[SupertabConnect] fastlyHandleRequests failed:",o),await fetch(e,{backend:r})}}static async cloudfrontHandleRequests(e,n){try{let r=new u({apiKey:n.apiKey,botDetector:n.botDetector,enforcement:n.enforcement});return await z(r,e)}catch(r){return console.error("[SupertabConnect] cloudfrontHandleRequests failed:",r),e?.Records?.[0]?.cf?.request??{}}}};u.baseUrl="https://api-connect.supertab.co",u._instance=null;var P=u;0&&(module.exports={EnforcementMode,HandlerAction,LicenseTokenInvalidReason,SupertabConnect,defaultBotDetector});
//# sourceMappingURL=index.cjs.map