"use strict";var E=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var C=Object.prototype.hasOwnProperty;var x=(s,e)=>{for(var n in e)E(s,n,{get:e[n],enumerable:!0})},D=(s,e,n,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of N(e))!C.call(s,r)&&r!==n&&E(s,r,{get:()=>e[r],enumerable:!(t=P(e,r))||t.enumerable});return s};var q=s=>D(E({},"__esModule",{value:!0}),s);var V={};x(V,{SupertabConnect:()=>L});module.exports=q(V);var f="stc-backend";var w=require("jose");async function F(s,e,n){try{let t=await fetch(s,e);if(!t.ok){let i=await t.text().catch(()=>""),o=`Failed to obtain license token: ${t.status} ${t.statusText}${i?` - ${i}`:""}`;throw new Error(o)}let r;try{r=await t.json()}catch(i){throw n&&console.error("Failed to parse license token response as JSON:",i),new Error("Failed to parse license token response as JSON")}if(!r?.access_token)throw new Error("License token response missing access_token");return r.access_token}catch(t){throw n&&console.error("Error generating license token:",t),t}}async function K(s,e){let n=["ES256","RS256"];for(let t of n)try{return{key:await(0,w.importPKCS8)(s,t),alg:t}}catch(r){e&&console.debug(`Private key did not import using ${t}, retrying...`,r)}throw new Error("Unsupported private key format. Expected RSA or P-256 EC private key.")}async function v({clientId:s,kid:e,privateKeyPem:n,tokenEndpoint:t,resourceUrl:r,licenseXml:i,debug:o}){let{key:u,alg:p}=await K(n,o),g=Math.floor(Date.now()/1e3),c=await new w.SignJWT({}).setProtectedHeader({alg:p,kid:e}).setIssuer(s).setSubject(s).setIssuedAt(g).setExpirationTime(g+300).setAudience(t).sign(u),a=new URLSearchParams({grant_type:"rsl",client_assertion_type:"urn:ietf:params:oauth:client-assertion-type:jwt-bearer",client_assertion:c,license:i,resource:r}),d={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:a.toString()};return F(t,d,o)}var m=require("jose");var _=new Map;function O(){let s={method:"GET"};return globalThis?.fastly&&(s={...s,backend:f}),s}async function J({cacheKey:s,url:e,debug:n,failureMessage:t,logLabel:r}){if(!_.has(s))try{let i=await fetch(e,O());if(!i.ok)throw new Error(`${t}: ${i.status}`);let o=await i.json();_.set(s,o)}catch(i){throw n&&console.error(r,i),i}return _.get(s)}async function T(s,e){let n=`${s}/.well-known/jwks.json/platform`;return console.log("Fetching platform JWKS from:",n),J({cacheKey:"platform_jwks",url:n,debug:e,failureMessage:"Failed to fetch platform JWKS",logLabel:"Error fetching platform JWKS:"})}var I=s=>s.replace(/\/+$/,"");async function A({licenseToken:s,requestUrl:e,supertabBaseUrl:n,debug:t}){if(!s)return{valid:!1,reason:"missing_license_token"};let r;try{r=(0,m.decodeProtectedHeader)(s)}catch(a){return t&&console.error("Invalid license JWT header:",a),{valid:!1,reason:"invalid_license_header"}}if(r.alg!=="ES256")return t&&console.error("Unsupported license JWT alg:",r.alg),{valid:!1,reason:"invalid_license_algorithm"};let i;try{i=(0,m.decodeJwt)(s)}catch(a){return t&&console.error("Invalid license JWT payload:",a),{valid:!1,reason:"invalid_license_payload"}}let o=i.license_id,u=i.iss;if(!u||!u.startsWith(n))return t&&console.error("Invalid license JWT issuer:",u),{valid:!1,reason:"invalid_license_issuer",licenseId:o};let p=Array.isArray(i.aud)?i.aud.filter(a=>typeof a=="string"):typeof i.aud=="string"?[i.aud]:[],g=I(e);if(!p.some(a=>{let d=I(a);return d?g.startsWith(d):!1}))return t&&console.error("License JWT audience does not match request URL:",i.aud),{valid:!1,reason:"invalid_license_audience",licenseId:o};try{let a=await T(n,t),h=await(0,m.jwtVerify)(s,async y=>{let k=a.keys.find(U=>U.kid===y.kid);if(!k)throw new Error(`No matching platform key found: ${y.kid}`);return k},{issuer:u,algorithms:[r.alg],clockTolerance:"1m"});return{valid:!0,licenseId:o,payload:h.payload}}catch(a){return t&&console.error("License JWT verification failed:",a),a instanceof Error&&a.message?.includes("exp")?{valid:!1,reason:"license_token_expired",licenseId:o}:{valid:!1,reason:"license_signature_verification_failed",licenseId:o}}}function H({requestUrl:s}){let e=new URL(s);return`${e.protocol}//${e.host}/license.xml`}async function R({licenseToken:s,url:e,userAgent:n,ctx:t,supertabBaseUrl:r,merchantSystemUrn:i,debug:o,recordEvent:u}){let p=await A({licenseToken:s,requestUrl:e,supertabBaseUrl:r,debug:o});async function g(c){let a={page_url:e,user_agent:n,verification_status:p.valid?"valid":"invalid",verification_reason:p.reason||"success"},d=u(c,a,p.licenseId);return t?.waitUntil&&t.waitUntil(d),d}if(!p.valid){await g(p.reason||"license_token_verification_failed");let c="invalid_request",a="Access to this resource requires a license";switch(p.reason){case"missing_license_token":c="invalid_request",a="Access to this resource requires a license";break;case"license_token_expired":c="invalid_token",a="The license token has expired";break;case"license_signature_verification_failed":c="invalid_token",a="The license token signature is invalid";break;case"invalid_license_header":c="invalid_token",a="The license token header is invalid";break;case"invalid_license_payload":c="invalid_token",a="The license token payload is invalid";break;case"invalid_license_issuer":c="invalid_token",a="The license token issuer is invalid";break;case"invalid_license_audience":c="invalid_token",a="The license token audience is invalid";break;default:c="invalid_request",a="Access to this resource requires a license"}let d=H({requestUrl:e}),h=`${r}/docs/errors#${c}`,y=new Headers({"Content-Type":"text/plain; charset=UTF-8","WWW-Authenticate":`License error="${c}", error_description="${a}", error_uri="${h}"`,Link:`${d}; rel="license"; type="application/rsl+xml"`}),k=`Access to this resource requires a valid license token. Error: ${c} - ${a}`;return new Response(k,{status:401,headers:y})}return await g("license_used"),new Response("\u2705 License Token Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})})}function $(){let s={method:"GET"};return globalThis?.fastly&&(s={...s,backend:f}),s}async function S(s,e){let n=`${s}/merchants/systems/${e}/license.xml`,t=await fetch(n,$());if(!t.ok)return new Response("License not found",{status:404});let r=await t.text();return new Response(r,{status:200,headers:new Headers({"Content-Type":"application/xml"})})}var b=!0,l=class l{constructor(e,n=!1){if(!n&&l._instance){if(!(e.apiKey===l._instance.apiKey&&e.merchantSystemUrn===l._instance.merchantSystemUrn))throw new Error("Cannot create a new instance with different configuration. Use resetInstance to clear the existing instance.");return l._instance}if(n&&l._instance&&l.resetInstance(),!e.apiKey||!e.merchantSystemUrn)throw new Error("Missing required configuration: apiKey and merchantSystemUrn are required");this.apiKey=e.apiKey,this.merchantSystemUrn=e.merchantSystemUrn,l._instance=this}static resetInstance(){l._instance=null}static setBaseUrl(e){l.baseUrl=e}async verifyLicenseToken(e,n){return A({licenseToken:e,requestUrl:n,supertabBaseUrl:l.baseUrl,debug:b})}async recordEvent(e,n={},t){let r={event_name:e,merchant_system_urn:this.merchantSystemUrn?this.merchantSystemUrn:"",license_id:t,properties:n};try{let i={method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(r)};globalThis?.fastly&&(i={...i,backend:f});let o=await fetch(`${l.baseUrl}/events`,i);o.ok||console.log(`Failed to record event: ${o.status}`)}catch(i){console.log("Error recording event:",i)}}static checkIfBotRequest(e){let n=e.headers.get("User-Agent")||"",t=e.headers.get("accept")||"",r=e.headers.get("sec-ch-ua"),i=e.headers.get("accept-language"),o=e.cf?.botManagement?.score,u=["chatgpt-user","perplexitybot","gptbot","anthropic-ai","ccbot","claude-web","claudebot","cohere-ai","youbot","diffbot","oai-searchbot","meta-externalagent","timpibot","amazonbot","bytespider","perplexity-user","googlebot","bot","curl","wget"],p=n.toLowerCase(),g=u.some(y=>p.includes(y)),c=n.toLowerCase().includes("headless")||n.toLowerCase().includes("puppeteer")||!r,a=!n.toLowerCase().includes("headless")||!n.toLowerCase().includes("puppeteer")||!r,d=!t||!i,h=typeof o=="number"&&o<30;return console.log("Bot Detection Details:",{botUaMatch:g,headlessIndicators:c,missingHeaders:d,lowBotScore:h,botScore:o}),(p.includes("safari")||p.includes("mozilla"))&&c&&a?!1:g||c||d||h}static async cloudflareHandleRequests(e,n,t){let{MERCHANT_SYSTEM_URN:r,MERCHANT_API_KEY:i}=n;return new l({apiKey:i,merchantSystemUrn:r}).handleRequest(e,l.checkIfBotRequest,t)}static async fastlyHandleRequests(e,n,t,r=!1){let i=new l({apiKey:t,merchantSystemUrn:n});return r&&new URL(e.url).pathname==="/license.xml"?await S(l.baseUrl,n):i.handleRequest(e,l.checkIfBotRequest,null)}async handleRequest(e,n,t){let r=e.headers.get("Authorization")||"",i=r.startsWith("License ")?r.slice(8):"",o=e.url,u=e.headers.get("User-Agent")||"unknown";return n&&!n(e,t)?new Response("\u2705 Non-Bot Content Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})}):R({licenseToken:i,url:o,userAgent:u,ctx:t,supertabBaseUrl:l.baseUrl,merchantSystemUrn:this.merchantSystemUrn,debug:b,recordEvent:(p,g,c)=>this.recordEvent(p,g,c)})}static async generateLicenseToken(e,n,t,r,i){let o=l.baseUrl+"/rsl/token";return v({clientId:e,kid:n,privateKeyPem:t,tokenEndpoint:o,resourceUrl:r,licenseXml:i,debug:b})}};l.baseUrl="https://api-connect.supertab.co",l._instance=null;var L=l;0&&(module.exports={SupertabConnect});
//# sourceMappingURL=index.cjs.map