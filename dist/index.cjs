"use strict";var w=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var C=Object.prototype.hasOwnProperty;var x=(r,e)=>{for(var t in e)w(r,t,{get:e[t],enumerable:!0})},D=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of N(e))!C.call(r,i)&&i!==t&&w(r,i,{get:()=>e[i],enumerable:!(n=P(e,i))||n.enumerable});return r};var q=r=>D(w({},"__esModule",{value:!0}),r);var $={};x($,{SupertabConnect:()=>A});module.exports=q($);var f="stc-backend";var L=require("jose");async function F(r,e,t){try{let n=await fetch(r,e);if(!n.ok){let s=await n.text().catch(()=>""),o=`Failed to obtain license token: ${n.status} ${n.statusText}${s?` - ${s}`:""}`;throw new Error(o)}let i;try{i=await n.json()}catch(s){throw t&&console.error("Failed to parse license token response as JSON:",s),new Error("Failed to parse license token response as JSON")}if(!i?.access_token)throw new Error("License token response missing access_token");return i.access_token}catch(n){throw t&&console.error("Error generating license token:",n),n}}async function v({clientId:r,clientSecret:e,tokenEndpoint:t,resourceUrl:n,licenseXml:i,debug:s}){let o=new URLSearchParams({grant_type:"client_credentials",license:i,resource:n}),p={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json",Authorization:"Basic "+btoa(`${r}:${e}`)},body:o.toString()};return F(t,p,s)}var m=require("jose");var E=new Map;function K(){let r={method:"GET"};return globalThis?.fastly&&(r={...r,backend:f}),r}async function O({cacheKey:r,url:e,debug:t,failureMessage:n,logLabel:i}){if(!E.has(r))try{let s=await fetch(e,K());if(!s.ok)throw new Error(`${n}: ${s.status}`);let o=await s.json();E.set(r,o)}catch(s){throw t&&console.error(i,s),s}return E.get(r)}async function T(r,e){let t=`${r}/.well-known/jwks.json/platform`;return console.log("Fetching platform JWKS from:",t),O({cacheKey:"platform_jwks",url:t,debug:e,failureMessage:"Failed to fetch platform JWKS",logLabel:"Error fetching platform JWKS:"})}var I=r=>r.replace(/\/+$/,"");async function b({licenseToken:r,requestUrl:e,supertabBaseUrl:t,debug:n}){if(!r)return{valid:!1,reason:"missing_license_token"};let i;try{i=(0,m.decodeProtectedHeader)(r)}catch(a){return n&&console.error("Invalid license JWT header:",a),{valid:!1,reason:"invalid_license_header"}}if(i.alg!=="ES256")return n&&console.error("Unsupported license JWT alg:",i.alg),{valid:!1,reason:"invalid_license_algorithm"};let s;try{s=(0,m.decodeJwt)(r)}catch(a){return n&&console.error("Invalid license JWT payload:",a),{valid:!1,reason:"invalid_license_payload"}}let o=s.license_id,p=s.iss;if(!p||!p.startsWith(t))return n&&console.error("Invalid license JWT issuer:",p),{valid:!1,reason:"invalid_license_issuer",licenseId:o};let d=Array.isArray(s.aud)?s.aud.filter(a=>typeof a=="string"):typeof s.aud=="string"?[s.aud]:[],g=I(e);if(!d.some(a=>{let u=I(a);return u?g.startsWith(u):!1}))return n&&console.error("License JWT audience does not match request URL:",s.aud),{valid:!1,reason:"invalid_license_audience",licenseId:o};try{let a=await T(t,n),h=await(0,m.jwtVerify)(r,async y=>{let k=a.keys.find(U=>U.kid===y.kid);if(!k)throw new Error(`No matching platform key found: ${y.kid}`);return k},{issuer:p,algorithms:[i.alg],clockTolerance:"1m"});return{valid:!0,licenseId:o,payload:h.payload}}catch(a){return n&&console.error("License JWT verification failed:",a),a instanceof Error&&a.message?.includes("exp")?{valid:!1,reason:"license_token_expired",licenseId:o}:{valid:!1,reason:"license_signature_verification_failed",licenseId:o}}}function J({requestUrl:r}){let e=new URL(r);return`${e.protocol}//${e.host}/license.xml`}async function R({licenseToken:r,url:e,userAgent:t,ctx:n,supertabBaseUrl:i,merchantSystemUrn:s,debug:o,recordEvent:p}){let d=await b({licenseToken:r,requestUrl:e,supertabBaseUrl:i,debug:o});async function g(l){let a={page_url:e,user_agent:t,verification_status:d.valid?"valid":"invalid",verification_reason:d.reason||"success"},u=p(l,a,d.licenseId);return n?.waitUntil&&n.waitUntil(u),u}if(!d.valid){await g(d.reason||"license_token_verification_failed");let l="invalid_request",a="Access to this resource requires a license";switch(d.reason){case"missing_license_token":l="invalid_request",a="Access to this resource requires a license";break;case"license_token_expired":l="invalid_token",a="The license token has expired";break;case"license_signature_verification_failed":l="invalid_token",a="The license token signature is invalid";break;case"invalid_license_header":l="invalid_token",a="The license token header is invalid";break;case"invalid_license_payload":l="invalid_token",a="The license token payload is invalid";break;case"invalid_license_issuer":l="invalid_token",a="The license token issuer is invalid";break;case"invalid_license_audience":l="invalid_token",a="The license token audience is invalid";break;default:l="invalid_request",a="Access to this resource requires a license"}let u=J({requestUrl:e}),h=`${i}/docs/errors#${l}`,y=new Headers({"Content-Type":"text/plain; charset=UTF-8","WWW-Authenticate":`License error="${l}", error_description="${a}", error_uri="${h}"`,Link:`${u}; rel="license"; type="application/rsl+xml"`}),k=`Access to this resource requires a valid license token. Error: ${l} - ${a}`;return new Response(k,{status:401,headers:y})}return await g("license_used"),new Response("\u2705 License Token Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})})}function H(){let r={method:"GET"};return globalThis?.fastly&&(r={...r,backend:f}),r}async function S(r,e){let t=`${r}/merchants/systems/${e}/license.xml`,n=await fetch(t,H());if(!n.ok)return new Response("License not found",{status:404});let i=await n.text();return new Response(i,{status:200,headers:new Headers({"Content-Type":"application/xml"})})}var _=!0,c=class c{constructor(e,t=!1){if(!t&&c._instance){if(!(e.apiKey===c._instance.apiKey&&e.merchantSystemUrn===c._instance.merchantSystemUrn))throw new Error("Cannot create a new instance with different configuration. Use resetInstance to clear the existing instance.");return c._instance}if(t&&c._instance&&c.resetInstance(),!e.apiKey||!e.merchantSystemUrn)throw new Error("Missing required configuration: apiKey and merchantSystemUrn are required");this.apiKey=e.apiKey,this.merchantSystemUrn=e.merchantSystemUrn,c._instance=this}static resetInstance(){c._instance=null}static setBaseUrl(e){c.baseUrl=e}async verifyLicenseToken(e,t){return b({licenseToken:e,requestUrl:t,supertabBaseUrl:c.baseUrl,debug:_})}async recordEvent(e,t={},n){let i={event_name:e,merchant_system_urn:this.merchantSystemUrn?this.merchantSystemUrn:"",license_id:n,properties:t};try{let s={method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(i)};globalThis?.fastly&&(s={...s,backend:f});let o=await fetch(`${c.baseUrl}/events`,s);o.ok||console.log(`Failed to record event: ${o.status}`)}catch(s){console.log("Error recording event:",s)}}static checkIfBotRequest(e){let t=e.headers.get("User-Agent")||"",n=e.headers.get("accept")||"",i=e.headers.get("sec-ch-ua"),s=e.headers.get("accept-language"),o=e.cf?.botManagement?.score,p=["chatgpt-user","perplexitybot","gptbot","anthropic-ai","ccbot","claude-web","claudebot","cohere-ai","youbot","diffbot","oai-searchbot","meta-externalagent","timpibot","amazonbot","bytespider","perplexity-user","googlebot","bot","curl","wget"],d=t.toLowerCase(),g=p.some(y=>d.includes(y)),l=t.toLowerCase().includes("headless")||t.toLowerCase().includes("puppeteer")||!i,a=!t.toLowerCase().includes("headless")||!t.toLowerCase().includes("puppeteer")||!i,u=!n||!s,h=typeof o=="number"&&o<30;return console.log("Bot Detection Details:",{botUaMatch:g,headlessIndicators:l,missingHeaders:u,lowBotScore:h,botScore:o}),(d.includes("safari")||d.includes("mozilla"))&&l&&a?!1:g||l||u||h}static async cloudflareHandleRequests(e,t,n){let{MERCHANT_SYSTEM_URN:i,MERCHANT_API_KEY:s}=t;return new c({apiKey:s,merchantSystemUrn:i}).handleRequest(e,c.checkIfBotRequest,n)}static async fastlyHandleRequests(e,t,n,i=!1){let s=new c({apiKey:n,merchantSystemUrn:t});return i&&new URL(e.url).pathname==="/license.xml"?await S(c.baseUrl,t):s.handleRequest(e,c.checkIfBotRequest,null)}async handleRequest(e,t,n){let i=e.headers.get("Authorization")||"",s=i.startsWith("License ")?i.slice(8):"",o=e.url,p=e.headers.get("User-Agent")||"unknown";return t&&!t(e,n)?new Response("\u2705 Non-Bot Content Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})}):R({licenseToken:s,url:o,userAgent:p,ctx:n,supertabBaseUrl:c.baseUrl,merchantSystemUrn:this.merchantSystemUrn,debug:_,recordEvent:(d,g,l)=>this.recordEvent(d,g,l)})}static async obtainLicenseToken(e,t,n,i){let s=c.baseUrl+"/rsl/token";return v({clientId:e,clientSecret:t,tokenEndpoint:s,resourceUrl:n,licenseXml:i,debug:_})}};c.baseUrl="https://api-connect.supertab.co",c._instance=null;var A=c;0&&(module.exports={SupertabConnect});
//# sourceMappingURL=index.cjs.map