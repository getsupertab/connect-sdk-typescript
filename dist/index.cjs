"use strict";var I=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var H=(a,e)=>{for(var t in e)I(a,t,{get:e[t],enumerable:!0})},q=(a,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of J(e))!x.call(a,n)&&n!==t&&I(a,n,{get:()=>e[n],enumerable:!(s=D(e,n))||s.enumerable});return a};var K=a=>q(I({},"__esModule",{value:!0}),a);var j={};H(j,{SupertabConnect:()=>S});module.exports=K(j);var h="stc-backend";var E=require("jose");var w=require("jose");async function W(a,e){let t=["ES256","RS256"];for(let s of t)try{return{key:await(0,w.importPKCS8)(a,s),alg:s}}catch(n){e&&console.debug(`Private key did not import using ${s}, retrying...`,n)}throw new Error("Unsupported private key format. Expected RSA or P-256 EC private key.")}async function L({clientId:a,kid:e,privateKeyPem:t,tokenEndpoint:s,resourceUrl:n,licenseXml:r,debug:i}){let{key:u,alg:d}=await W(t,i),p=Math.floor(Date.now()/1e3),c=await new w.SignJWT({}).setProtectedHeader({alg:d,kid:e}).setIssuer(a).setSubject(a).setIssuedAt(p).setExpirationTime(p+300).setAudience(s).sign(u),o=new URLSearchParams({grant_type:"rsl",client_assertion_type:"urn:ietf:params:oauth:client-assertion-type:jwt-bearer",client_assertion:c,license:r,resource:n}),f={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:o.toString()};try{let g=await fetch(s,f);if(!g.ok){let m=await g.text().catch(()=>""),A=`Failed to obtain license token: ${g.status} ${g.statusText}${m?` - ${m}`:""}`;throw new Error(A)}let y;try{y=await g.json()}catch(m){throw i&&console.error("Failed to parse license token response as JSON:",m),new Error("Failed to parse license token response as JSON")}if(!y?.access_token)throw new Error("License token response missing access_token");return y.access_token}catch(g){throw i&&console.error("Error generating license token:",g),g}}async function T({customerURN:a,kid:e,privateKeyPem:t,expirationSeconds:s=3600}){let n="RS256",r=await(0,w.importPKCS8)(t,n),i=Math.floor(Date.now()/1e3);return new w.SignJWT({}).setProtectedHeader({alg:n,kid:e}).setIssuer(a).setIssuedAt(i).setExpirationTime(i+s).sign(r)}var _=require("jose");var v=new Map;function F(){let a={method:"GET"};return globalThis?.fastly&&(a={...a,backend:h}),a}async function b({cacheKey:a,url:e,debug:t,failureMessage:s,logLabel:n}){if(!v.has(a))try{let r=await fetch(e,F());if(!r.ok)throw new Error(`${s}: ${r.status}`);let i=await r.json();v.set(a,i)}catch(r){throw t&&console.error(n,r),r}return v.get(a)}async function P(a,e,t){let s=`${a}/.well-known/jwks.json/${encodeURIComponent(e)}`;return b({cacheKey:e,url:s,debug:t,failureMessage:"Failed to fetch JWKS",logLabel:"Error fetching JWKS:"})}async function U(a,e){let t=`${a}/.well-known/jwks.json/platform`;return console.log("Fetching platform JWKS from:",t),b({cacheKey:"platform_jwks",url:t,debug:e,failureMessage:"Failed to fetch platform JWKS",logLabel:"Error fetching platform JWKS:"})}var N=a=>a.replace(/\/+$/,"");async function V({licenseToken:a,requestUrl:e,supertabBaseUrl:t,debug:s}){if(!a)return{valid:!1,reason:"missing_license_token"};let n;try{n=(0,_.decodeProtectedHeader)(a)}catch(o){return s&&console.error("Invalid license JWT header:",o),{valid:!1,reason:"invalid_license_header"}}if(n.alg!=="ES256")return s&&console.error("Unsupported license JWT alg:",n.alg),{valid:!1,reason:"invalid_license_algorithm"};let r;try{r=(0,_.decodeJwt)(a)}catch(o){return s&&console.error("Invalid license JWT payload:",o),{valid:!1,reason:"invalid_license_payload"}}let i=r.license_id,u=r.iss;if(!u||!u.startsWith(t))return s&&console.error("Invalid license JWT issuer:",u),{valid:!1,reason:"invalid_license_issuer",licenseId:i};let d=Array.isArray(r.aud)?r.aud.filter(o=>typeof o=="string"):typeof r.aud=="string"?[r.aud]:[],p=N(e);if(!d.some(o=>{let f=N(o);return f?p.startsWith(f):!1}))return s&&console.error("License JWT audience does not match request URL:",r.aud),{valid:!1,reason:"invalid_license_audience",licenseId:i};try{let o=await U(t,s),g=await(0,_.jwtVerify)(a,async y=>{let m=o.keys.find(A=>A.kid===y.kid);if(!m)throw new Error(`No matching platform key found: ${y.kid}`);return m},{issuer:u,algorithms:[n.alg],clockTolerance:"1m"});return{valid:!0,licenseId:i,payload:g.payload}}catch(o){return s&&console.error("License JWT verification failed:",o),o instanceof Error&&o.message?.includes("exp")?{valid:!1,reason:"license_token_expired",licenseId:i}:{valid:!1,reason:"license_signature_verification_failed",licenseId:i}}}function O({requestUrl:a}){let e=new URL(a);return`${e.protocol}//${e.host}/license.xml`}async function C({licenseToken:a,url:e,userAgent:t,ctx:s,supertabBaseUrl:n,merchantSystemUrn:r,debug:i,recordEvent:u}){let d=await V({licenseToken:a,requestUrl:e,supertabBaseUrl:n,debug:i});async function p(c){let o={page_url:e,user_agent:t,verification_status:d.valid?"valid":"invalid",verification_reason:d.reason||"success"},f=u(c,o,d.licenseId);return s?.waitUntil&&s.waitUntil(f),f}if(!d.valid){await p(d.reason||"license_token_verification_failed");let c="invalid_request",o="Access to this resource requires a license";switch(d.reason){case"missing_license_token":c="invalid_request",o="Access to this resource requires a license";break;case"license_token_expired":c="invalid_token",o="The license token has expired";break;case"license_signature_verification_failed":c="invalid_token",o="The license token signature is invalid";break;case"invalid_license_header":c="invalid_token",o="The license token header is invalid";break;case"invalid_license_payload":c="invalid_token",o="The license token payload is invalid";break;case"invalid_license_issuer":c="invalid_token",o="The license token issuer is invalid";break;case"invalid_license_audience":c="invalid_token",o="The license token audience is invalid";break;default:c="invalid_request",o="Access to this resource requires a license"}let f=O({requestUrl:e}),g=`${n}/docs/errors#${c}`,y=new Headers({"Content-Type":"text/plain; charset=UTF-8","WWW-Authenticate":`License error="${c}", error_description="${o}", error_uri="${g}"`,Link:`${f}; rel="license"; type="application/rsl+xml"`}),m=`Access to this resource requires a valid license token. Error: ${c} - ${o}`;return new Response(m,{status:401,headers:y})}return await p("license_used"),new Response("\u2705 License Token Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})})}function $(){let a={method:"GET"};return globalThis?.fastly&&(a={...a,backend:h}),a}async function R(a,e){let t=`${a}/merchants/systems/${e}/license.xml`,s=await fetch(t,$());if(!s.ok)return new Response("License not found",{status:404});let n=await s.text();return new Response(n,{status:200,headers:new Headers({"Content-Type":"application/xml"})})}var k=!0,l=class l{constructor(e,t=!1){if(!t&&l._instance){if(!(e.apiKey===l._instance.apiKey&&e.merchantSystemUrn===l._instance.merchantSystemUrn))throw new Error("Cannot create a new instance with different configuration. Use resetInstance to clear the existing instance.");return l._instance}if(t&&l._instance&&l.resetInstance(),!e.apiKey||!e.merchantSystemUrn)throw new Error("Missing required configuration: apiKey and merchantSystemUrn are required");this.apiKey=e.apiKey,this.merchantSystemUrn=e.merchantSystemUrn,l._instance=this}static resetInstance(){l._instance=null}static setBaseUrl(e){l.baseUrl=e}async verifyToken(e){if(!e)return{valid:!1,reason:"missing_token"};let t;try{t=(0,E.decodeProtectedHeader)(e)}catch(r){return k&&console.error("Invalid JWT header:",r),{valid:!1,reason:"invalid_header"}}if(t.alg!=="RS256")return{valid:!1,reason:"invalid_algorithm"};let s;try{s=(0,E.decodeJwt)(e)}catch(r){return k&&console.error("Invalid JWT payload:",r),{valid:!1,reason:"invalid_payload"}}let n=s.iss;if(!n||!n.startsWith("urn:stc:customer:"))return{valid:!1,reason:"invalid_issuer"};try{let r=await P(l.baseUrl,n,k);return{valid:!0,payload:(await(0,E.jwtVerify)(e,async d=>{let p=r.keys.find(c=>c.kid===d.kid);if(!p)throw new Error(`No matching key found: ${d.kid}`);return p},{issuer:n,algorithms:["RS256"],clockTolerance:"1m"})).payload}}catch(r){return k&&console.error("JWT verification failed:",r),r.message?.includes("exp")?{valid:!1,reason:"token_expired"}:{valid:!1,reason:"signature_verification_failed"}}}async recordEvent(e,t={},s){let n={event_name:e,merchant_system_urn:this.merchantSystemUrn?this.merchantSystemUrn:"",license_id:s,properties:t};try{let r={method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(n)};globalThis?.fastly&&(r={...r,backend:h});let i=await fetch(`${l.baseUrl}/events`,r);i.ok||console.log(`Failed to record event: ${i.status}`)}catch(r){console.log("Error recording event:",r)}}async baseHandleRequest(e,t,s,n){let r=await this.verifyToken(e);async function i(u,d,p){let c={page_url:t,user_agent:s,verification_status:r.valid?"valid":"invalid",verification_reason:r.reason||"success"};if(p){let o=u.recordEvent(d,c);return p.waitUntil(o),o}else return await u.recordEvent(d,c)}if(!r.valid){await i(this,r.reason||"token_verification_failed",n);let u="Payment required: you need to present a valid Supertab Connect token to access this content. Check out the provided url for details",d="\u274C Content access denied"+(r.reason?`: ${r.reason}`:""),c={url:`${l.baseUrl}/merchants/systems/${this.merchantSystemUrn}/content-access.json`,message:u,details:d};return new Response(JSON.stringify(c),{status:402,headers:new Headers({"Content-Type":"application/json"})})}return await i(this,"page_viewed",n),new Response("\u2705 Content Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})})}async baseLicenseHandleRequest(e,t,s,n){return C({licenseToken:e,url:t,userAgent:s,ctx:n,supertabBaseUrl:l.baseUrl,merchantSystemUrn:this.merchantSystemUrn,debug:k,recordEvent:(r,i,u)=>this.recordEvent(r,i,u)})}extractDataFromRequest(e){let t=e.headers.get("Authorization")||"",s=t.startsWith("Bearer ")?t.slice(7):"",n=t.startsWith("License ")?t.slice(8):"",r=e.url,i=e.headers.get("User-Agent")||"unknown";return{token:s,licenseToken:n,url:r,user_agent:i}}static checkIfBotRequest(e){let t=e.headers.get("User-Agent")||"",s=e.headers.get("accept")||"",n=e.headers.get("sec-ch-ua"),r=e.headers.get("accept-language"),i=e.cf?.botManagement?.score,u=["chatgpt-user","perplexitybot","gptbot","anthropic-ai","ccbot","claude-web","claudebot","cohere-ai","youbot","diffbot","oai-searchbot","meta-externalagent","timpibot","amazonbot","bytespider","perplexity-user","googlebot","bot","curl","wget"],d=t.toLowerCase(),p=u.some(y=>d.includes(y)),c=t.toLowerCase().includes("headless")||t.toLowerCase().includes("puppeteer")||!n,o=!t.toLowerCase().includes("headless")||!t.toLowerCase().includes("puppeteer")||!n,f=!s||!r,g=typeof i=="number"&&i<30;return console.log("Bot Detection Details:",{botUaMatch:p,headlessIndicators:c,missingHeaders:f,lowBotScore:g,botScore:i}),(d.includes("safari")||d.includes("mozilla"))&&c&&o?!1:p||c||f||g}static async cloudflareHandleRequests(e,t,s){let{MERCHANT_SYSTEM_URN:n,MERCHANT_API_KEY:r}=t;return new l({apiKey:r,merchantSystemUrn:n}).handleRequest(e,l.checkIfBotRequest,s)}static async fastlyHandleRequests(e,t,s,n=!1){let r=new l({apiKey:s,merchantSystemUrn:t});return n&&new URL(e.url).pathname==="/license.xml"?await R(l.baseUrl,t):r.handleRequest(e,l.checkIfBotRequest,null)}async handleRequest(e,t,s){let{token:n,licenseToken:r,url:i,user_agent:u}=this.extractDataFromRequest(e);return t&&!t(e,s)?new Response("\u2705 Non-Bot Content Access granted",{status:200,headers:new Headers({"Content-Type":"application/json"})}):n?this.baseHandleRequest(n,i,u,s):this.baseLicenseHandleRequest(r,i,u,s)}async hostRSLicenseXML(){return R(l.baseUrl,this.merchantSystemUrn)}static async generateLicenseToken(e,t,s,n,r){let i=l.baseUrl+"/rsl/token";return L({clientId:e,kid:t,privateKeyPem:s,tokenEndpoint:i,resourceUrl:n,licenseXml:r,debug:k})}static async generateCustomerJWT(e,t,s,n=3600){return T({customerURN:e,kid:t,privateKeyPem:s,expirationSeconds:n})}};l.baseUrl="https://api-connect.supertab.co",l._instance=null;var S=l;0&&(module.exports={SupertabConnect});
//# sourceMappingURL=index.cjs.map